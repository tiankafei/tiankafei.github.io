<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IO | tiankafei - java相关技术栈</title>
    <meta name="generator" content="VuePress 1.5.4">
    
    <meta name="description" content="自己写的一些东西的记录，包括代码与笔记，jdk最低支持1.8">
    <link rel="preload" href="/assets/css/0.styles.ccac5a78.css" as="style"><link rel="preload" href="/assets/js/app.f48ead2e.js" as="script"><link rel="preload" href="/assets/js/2.d3d861b7.js" as="script"><link rel="preload" href="/assets/js/28.0afbf7d8.js" as="script"><link rel="prefetch" href="/assets/js/10.e439aa4b.js"><link rel="prefetch" href="/assets/js/100.601d54c0.js"><link rel="prefetch" href="/assets/js/101.0886539c.js"><link rel="prefetch" href="/assets/js/102.27c1fb1f.js"><link rel="prefetch" href="/assets/js/103.bccc3857.js"><link rel="prefetch" href="/assets/js/104.dececfc7.js"><link rel="prefetch" href="/assets/js/105.d7c845b4.js"><link rel="prefetch" href="/assets/js/11.ee448843.js"><link rel="prefetch" href="/assets/js/12.82a411a0.js"><link rel="prefetch" href="/assets/js/13.674cb089.js"><link rel="prefetch" href="/assets/js/14.4caf57f3.js"><link rel="prefetch" href="/assets/js/15.3aee0120.js"><link rel="prefetch" href="/assets/js/16.5684be3c.js"><link rel="prefetch" href="/assets/js/17.268dd000.js"><link rel="prefetch" href="/assets/js/18.a581d88a.js"><link rel="prefetch" href="/assets/js/19.b1270b18.js"><link rel="prefetch" href="/assets/js/20.7bb18f18.js"><link rel="prefetch" href="/assets/js/21.f234f84b.js"><link rel="prefetch" href="/assets/js/22.365028a5.js"><link rel="prefetch" href="/assets/js/23.4327c89a.js"><link rel="prefetch" href="/assets/js/24.e2742ab0.js"><link rel="prefetch" href="/assets/js/25.95731d6a.js"><link rel="prefetch" href="/assets/js/26.bdb32d34.js"><link rel="prefetch" href="/assets/js/27.5dbc8e33.js"><link rel="prefetch" href="/assets/js/29.d67242af.js"><link rel="prefetch" href="/assets/js/3.0b90710e.js"><link rel="prefetch" href="/assets/js/30.d99bc421.js"><link rel="prefetch" href="/assets/js/31.8f7357d7.js"><link rel="prefetch" href="/assets/js/32.60be5d4e.js"><link rel="prefetch" href="/assets/js/33.ad4276a5.js"><link rel="prefetch" href="/assets/js/34.72e0205f.js"><link rel="prefetch" href="/assets/js/35.2323a5da.js"><link rel="prefetch" href="/assets/js/36.318e0ef7.js"><link rel="prefetch" href="/assets/js/37.64a56060.js"><link rel="prefetch" href="/assets/js/38.7edcb911.js"><link rel="prefetch" href="/assets/js/39.bb2a62f2.js"><link rel="prefetch" href="/assets/js/4.5ed19beb.js"><link rel="prefetch" href="/assets/js/40.ffd785db.js"><link rel="prefetch" href="/assets/js/41.324f1dbe.js"><link rel="prefetch" href="/assets/js/42.d19c4707.js"><link rel="prefetch" href="/assets/js/43.0e5bf0b0.js"><link rel="prefetch" href="/assets/js/44.bdccfed6.js"><link rel="prefetch" href="/assets/js/45.1815f572.js"><link rel="prefetch" href="/assets/js/46.a2285857.js"><link rel="prefetch" href="/assets/js/47.715b8e13.js"><link rel="prefetch" href="/assets/js/48.362a9afb.js"><link rel="prefetch" href="/assets/js/49.0dbac7aa.js"><link rel="prefetch" href="/assets/js/5.074eef47.js"><link rel="prefetch" href="/assets/js/50.51660a4f.js"><link rel="prefetch" href="/assets/js/51.a6e89345.js"><link rel="prefetch" href="/assets/js/52.eeae00ff.js"><link rel="prefetch" href="/assets/js/53.9fd61e1e.js"><link rel="prefetch" href="/assets/js/54.36a8c3d9.js"><link rel="prefetch" href="/assets/js/55.107f1c0f.js"><link rel="prefetch" href="/assets/js/56.7fe70286.js"><link rel="prefetch" href="/assets/js/57.46a293b7.js"><link rel="prefetch" href="/assets/js/58.89033854.js"><link rel="prefetch" href="/assets/js/59.9cd491fa.js"><link rel="prefetch" href="/assets/js/6.a7d67bfd.js"><link rel="prefetch" href="/assets/js/60.5f8bf550.js"><link rel="prefetch" href="/assets/js/61.6fc8a6a5.js"><link rel="prefetch" href="/assets/js/62.b4cf79de.js"><link rel="prefetch" href="/assets/js/63.6d20f30a.js"><link rel="prefetch" href="/assets/js/64.e0d6a7f2.js"><link rel="prefetch" href="/assets/js/65.103d2830.js"><link rel="prefetch" href="/assets/js/66.adcb1405.js"><link rel="prefetch" href="/assets/js/67.3a105d85.js"><link rel="prefetch" href="/assets/js/68.b72247a3.js"><link rel="prefetch" href="/assets/js/69.3d1ae7b5.js"><link rel="prefetch" href="/assets/js/7.5b52ee5d.js"><link rel="prefetch" href="/assets/js/70.7f53a973.js"><link rel="prefetch" href="/assets/js/71.ba72aea4.js"><link rel="prefetch" href="/assets/js/72.0fb9947a.js"><link rel="prefetch" href="/assets/js/73.8221bdad.js"><link rel="prefetch" href="/assets/js/74.004c8729.js"><link rel="prefetch" href="/assets/js/75.2c6cb00f.js"><link rel="prefetch" href="/assets/js/76.88932496.js"><link rel="prefetch" href="/assets/js/77.32029ead.js"><link rel="prefetch" href="/assets/js/78.4c9d8338.js"><link rel="prefetch" href="/assets/js/79.79ac972f.js"><link rel="prefetch" href="/assets/js/8.7b1c586a.js"><link rel="prefetch" href="/assets/js/80.9a58b9f7.js"><link rel="prefetch" href="/assets/js/81.58a8e0fc.js"><link rel="prefetch" href="/assets/js/82.8b6907ae.js"><link rel="prefetch" href="/assets/js/83.d2200ce5.js"><link rel="prefetch" href="/assets/js/84.51437037.js"><link rel="prefetch" href="/assets/js/85.3e12f2bc.js"><link rel="prefetch" href="/assets/js/86.09213c3e.js"><link rel="prefetch" href="/assets/js/87.849cc32d.js"><link rel="prefetch" href="/assets/js/88.33997068.js"><link rel="prefetch" href="/assets/js/89.92cbe0ec.js"><link rel="prefetch" href="/assets/js/9.5bc7f042.js"><link rel="prefetch" href="/assets/js/90.02a74afc.js"><link rel="prefetch" href="/assets/js/91.8d3c503d.js"><link rel="prefetch" href="/assets/js/92.3e3dbb4a.js"><link rel="prefetch" href="/assets/js/93.03dc8c01.js"><link rel="prefetch" href="/assets/js/94.b3c74db8.js"><link rel="prefetch" href="/assets/js/95.4b779928.js"><link rel="prefetch" href="/assets/js/96.7f598ab2.js"><link rel="prefetch" href="/assets/js/97.08cdbee2.js"><link rel="prefetch" href="/assets/js/98.719a5727.js"><link rel="prefetch" href="/assets/js/99.e068bcff.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ccac5a78.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">tiankafei - java相关技术栈</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/tiankafei-docs-java/Java基础.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/tiankafei-docs-spring/spring学习笔记/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/tiankafei-docs-架构/MySQL调优/" class="nav-link">
  架构
</a></div><div class="nav-item"><a href="/tiankafei-docs-大数据/centos7安装配置Hadoop/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/tiankafei-docs-linux/centos常用命令/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/tiankafei-docs-云/Centos7安装Docker并配置使用/" class="nav-link">
  云
</a></div><div class="nav-item"><a href="/tiankafei-docs-other/git上fork后再更新/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/tiankafei-docs-en/词性语法学习/" class="nav-link">
  英语
</a></div><div class="nav-item"><a href="https://github.com/tiankafei/tiankafei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/tiankafei-docs-java/Java基础.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/tiankafei-docs-spring/spring学习笔记/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/tiankafei-docs-架构/MySQL调优/" class="nav-link">
  架构
</a></div><div class="nav-item"><a href="/tiankafei-docs-大数据/centos7安装配置Hadoop/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/tiankafei-docs-linux/centos常用命令/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/tiankafei-docs-云/Centos7安装Docker并配置使用/" class="nav-link">
  云
</a></div><div class="nav-item"><a href="/tiankafei-docs-other/git上fork后再更新/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/tiankafei-docs-en/词性语法学习/" class="nav-link">
  英语
</a></div><div class="nav-item"><a href="https://github.com/tiankafei/tiankafei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tiankafei-docs-java/Java基础.html" class="sidebar-link">java基础</a></li><li><a href="/tiankafei-docs-java/java集合.html" class="sidebar-link">java集合</a></li><li><a href="/tiankafei-docs-java/多线程与高并发-JUC.html" class="sidebar-link">JUC</a></li><li><a href="/tiankafei-docs-java/JVM从入门到精通.html" class="sidebar-link">JVM入门到精通</a></li><li><a href="/tiankafei-docs-java/IO详情介绍.html" class="active sidebar-link">IO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#cpu多级缓存" class="sidebar-link">CPU多级缓存</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#cpu读取数据速率" class="sidebar-link">CPU读取数据速率</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#按块读取" class="sidebar-link">按块读取</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#cpu读取文件的过程" class="sidebar-link">CPU读取文件的过程</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#缓存行对齐" class="sidebar-link">缓存行对齐</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#page-cache-4k-页缓存" class="sidebar-link">Page Cache（4k,页缓存）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#处理逻辑" class="sidebar-link">处理逻辑</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#淘汰策略" class="sidebar-link">淘汰策略</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#配置参数解读" class="sidebar-link">配置参数解读</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#socket-i-o" class="sidebar-link">Socket I/O</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#常用命令" class="sidebar-link">常用命令</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#tcp" class="sidebar-link">TCP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#概念" class="sidebar-link">概念</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#socket" class="sidebar-link">Socket</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#bio" class="sidebar-link">BIO</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#nio" class="sidebar-link">NIO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#第一阶段" class="sidebar-link">第一阶段</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#第二阶段" class="sidebar-link">第二阶段</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#第三阶段" class="sidebar-link">第三阶段</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#bytebuffer" class="sidebar-link">ByteBuffer</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#mmap" class="sidebar-link">MMAP</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#顺序写入、mmap" class="sidebar-link">顺序写入、MMAP</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-java/IO详情介绍.html#zero拷贝" class="sidebar-link">Zero拷贝</a></li></ul></li><li><a href="/tiankafei-docs-java/Lambda表达式和StreamAPI用法.html" class="sidebar-link">Lambda表达式中，常用的接口</a></li><li><a href="/tiankafei-docs-java/设计模式.html" class="sidebar-link">设计模式</a></li><li><a href="/tiankafei-docs-java/树结构.html" class="sidebar-link">数据结构</a></li><li><a href="/tiankafei-docs-java/位运算.html" class="sidebar-link">二进制</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="io"><a href="#io" class="header-anchor">#</a> IO</h1> <h2 id="cpu多级缓存"><a href="#cpu多级缓存" class="header-anchor">#</a> CPU多级缓存</h2> <p><img src="/images/CPU.png" alt="CPU"></p> <h2 id="cpu读取数据速率"><a href="#cpu读取数据速率" class="header-anchor">#</a> CPU读取数据速率</h2> <p><img src="/images/CPU%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E9%80%9F%E7%8E%87.png" alt="CPU读取数据速率"></p> <p><strong>CPU : 内存 = 100 : 1</strong></p> <p><strong>内存 : 磁盘 = 100,000 : 1</strong></p> <h2 id="按块读取"><a href="#按块读取" class="header-anchor">#</a> 按块读取</h2> <p>程序局部性原理，可以提高效率，充分发挥总线<code>CPU</code>针脚等一次性读取更多数据的能力</p> <h2 id="cpu读取文件的过程"><a href="#cpu读取文件的过程" class="header-anchor">#</a> CPU读取文件的过程</h2> <p><code>CPU</code>给<code>DMA</code>发送指令，让磁盘把数据装到内存的某个位置（硬盘和内存直接打交道）。<code>DMA</code>直接内存访问。</p> <h2 id="缓存行对齐"><a href="#缓存行对齐" class="header-anchor">#</a> 缓存行对齐</h2> <p>一致性协议：<a href="https://www.cnblogs.com/z00377750/p/9180644.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/z00377750/p/9180644.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>CPU内部数据同步机制：</strong><font color="red">按缓存行</font>为单位进行数据同步的</p> <p>缓存行：</p> <p>缓存行越大，局部性空间效率越高，但读取时间慢
缓存行越小，局部性空间效率越低，但读取时间快
取一个折中值，目前多用：64字节</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 缓存行没有对齐</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T03_CacheLinePadding</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000_0000L</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000_0000L</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100_0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 缓存行对齐了</span>
<span class="token comment">// 一个long类型占用8个字节，一个缓存行占用64个字节，故声明一个长度为16的long类型的数组，只有两个值有用</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T04_CacheLinePadding</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000_0000L</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000_0000L</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                arr<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">100_0000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>**缓存行对齐：**对于有些特别敏感的数字，会存在线程高竞争的访问，为了保证不发生伪共享，可以使用缓存航对齐的编程方式</p> <p>对于有些特别敏感的数字，会存在线程高竞争的访问，为了保证不发生伪共享，可以使用缓存航对齐的编程方式。</p> <p>JDK7中，很多采用long padding提高效率</p> <p>JDK8，加入了@Contended注解（实验）需要加上：JVM -XX:-RestrictContended</p> <h2 id="page-cache-4k-页缓存"><a href="#page-cache-4k-页缓存" class="header-anchor">#</a> Page Cache（4k,页缓存）</h2> <h3 id="处理逻辑"><a href="#处理逻辑" class="header-anchor">#</a> 处理逻辑</h3> <p>当<code>page cache</code>达到系统配置最大值时，会触发<strong>脏的</strong><code>page cache</code>写磁盘，当写完磁盘之后，<strong>脏的状态</strong>会被清掉。</p> <p>当新的<code>page cache</code>分配不下的时候（分配的内存不够的时候），会淘汰一些不是脏的<code>page cache</code></p> <p>**脏的 <code>page cache</code>：**创建，删除，修改都会标记为脏（只要修改过就是脏的）</p> <h3 id="淘汰策略"><a href="#淘汰策略" class="header-anchor">#</a> 淘汰策略</h3> <blockquote><p><strong>只会淘汰不是脏的<code>page cache</code></strong></p></blockquote> <ol><li><p>LRU</p></li> <li><p>LFU</p></li></ol> <h3 id="配置参数解读"><a href="#配置参数解读" class="header-anchor">#</a> 配置参数解读</h3> <h2 id="socket-i-o"><a href="#socket-i-o" class="header-anchor">#</a> Socket I/O</h2> <h3 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h3> <p>netstat -natp</p> <p>jps</p> <p>lsof -p jps的进程id号（查看进程的详细信息）</p> <p>tcpdump -nn -i eth0 port 9090（tcp抓包）</p> <h2 id="tcp"><a href="#tcp" class="header-anchor">#</a> TCP</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>TCP是一个面向连接的，可靠的传输协议，需要三次握手，之后在内核级开辟资源（客户端和服务端都会开辟资源）</p> <h3 id="socket"><a href="#socket" class="header-anchor">#</a> Socket</h3> <p>内核级的四元组：服务的的ip，服务端的端口，客户端的ip，客户端的端口</p> <p>即便不进行连接的建立和数据的接收，也会开辟资源</p> <h2 id="bio"><a href="#bio" class="header-anchor">#</a> BIO</h2> <blockquote><p>这一阶段，内核是阻塞的，连接在内核层面被阻塞，应用程序一次只能拿到一个连接，只能一个一个进行处理（只有开启多线程，才能同时处理多个连接）</p></blockquote> <p>特点：</p> <ol><li>accept是阻塞的，如果不开启线程去处理请求的话，第二个连接就进不来，就会造成进程的阻塞</li> <li>为了解决这个问题，所以每一个客户端连接都会开启一个线程</li></ol> <p>存在的问题：</p> <ol><li>线程过多，就意味着CPU频繁的切换</li> <li>线程都有自己独立的堆空间，会造成内存的大量浪费</li></ol> <h2 id="nio"><a href="#nio" class="header-anchor">#</a> NIO</h2> <h3 id="第一阶段"><a href="#第一阶段" class="header-anchor">#</a> 第一阶段</h3> <blockquote><p>这一阶段，内核不是阻塞的了，可以把多个连接一起传给应用程序，应用程序拿着连接进行遍历（也可以开启多线程进行遍历），最终还是有多少个连接，就请求了多少次内核（不管连接是否有读写请求）。有多少个连接，用户空间就要和内核空间交互多少次。</p></blockquote> <p>特点：</p> <ol><li>内核发展，进程不用阻塞，可以循环遍历去处理每一个客户端的连接</li></ol> <p>存在的问题：</p> <ol><li>如果有一万个客户端同时连接，那么就需要进行O(n)次系统调用</li> <li>如果此时只有2个客户端发来数据了，那么就会造成大量的系统调用</li></ol> <h3 id="第二阶段"><a href="#第二阶段" class="header-anchor">#</a> 第二阶段</h3> <blockquote><p>这一阶段，内核产生了多路复用，应用程序把n个连接传给内核，内核主动轮询遍历，找到哪些连接有读写请求，然后把有读写请求的连接返给应用程序。</p></blockquote> <p>select：主动轮训的多路复用，给用户程序返回可读可写的状态</p> <p>特点：</p> <ol><li><p>新增加一个系统调用，内核把可用的文件描述符返回给用户程序</p> <p>如果有一万个客户端建立了连接（并不是所有客户端都在发送数据），用户程序（API）把一万个客户端的文件描述符一起发给内核，内核会返给用户程序，哪些可读，哪些可写，然后用户程序再进行下一步的处理。</p> <p>每循环一次的时间复杂度O(1)的select，O(n)的 recvform，会比原来性能好很多。</p></li></ol> <p>存在的问题：</p> <ol><li>调用的时候，会传递1万个文件描述，传递的数据很多。如果一个客户端多次发送数据，会产生重复传递/拷贝（每一次文件描述符的传递都会在用户空间和内核控件进行传递，很浪费性能）</li> <li>内核主动遍历，需要自己O(n)次遍历，找到可用的文件描述符，增加内核的资源消耗</li></ol> <h3 id="第三阶段"><a href="#第三阶段" class="header-anchor">#</a> 第三阶段</h3> <blockquote><p>这一阶段，内核可以开辟一块共享的存储空间（内核和应用程序都可以进行访问），用户把所有的连接放进该共享空间的红黑树结构中，当有读写请求过来以后，会产生中断，然后内核去红黑树结构中找到匹配的连接，放进链表结构中，应用程序只需要从链表结构中拿到有读写请求的连接即可。</p></blockquote> <p>epoll：基于事件的多路复用</p> <p>用户程序通过多路复用器，获知了哪些可以操作，然后自己去操作（同步）</p> <p>特点：</p> <ol start="2"><li>增加 epoll_create 系统调用，用来创建mmap（用户程序和内核共享的内存空间：一块供内核访问，数据结构是红黑树；一块供用户程序访问，数据结构是链表）</li> <li>增加 epoll_ctl（add,del）系统调用，存放客户端连接的文件描述，这个数据结构是红黑树</li> <li>当有网络请求过来之后，内核会把红黑树里面的数据放到链表里面，内核就不用再遍历了</li> <li>增加 epoll_wait 系统调用，用来接收链表返回的结果（因为还是有等待，也就是所谓的轮训接收，所以还是同步（zookeeper只要把监听事件注册上了，就不用管了，什么时候触发，由别人决定，这是异步）</li> <li>客户端连接的文件描述符当有数据发送和接收的时候，是怎么从1号内存空间转移到2号内存空间的？：通过网卡芯片的中断信号，会触发 callback，然后cpu就会从别的进程切换过来，发现数据到达了，就通过epoll的监听事件把文件描述符转移到2号内存空间，不需要遍历。</li> <li>epoll_wait 可以是阻塞的，也可以是非阻塞的，
<ol><li>redis 是非阻塞的：单进程单线程（需要做的事很多：本身的工作线程，LRU内存回收，RDB数据落地、AOF日志落地），所以不可能让 epoll_wait 处于阻塞状态。</li> <li>nginx是阻塞的：有守护进程有，工作进程，为了降低轮训带来的性能压力，故使用阻塞方式</li></ol></li></ol> <div class="language-shel extra-class"><pre class="language-text"><code>redis 启动的时候，先调用 epoll_create 创建一块内存空间5，
其次 redis 还需要调用 socket 也会得到一个文件描述符7，并把这个文件描述符7设置为非阻塞放进5的红黑树里面，
然后 redis 一直在不停的循环遍历 epoll_wait 获取链表中的数据

如果有客户端想要进来，就要和7号（socket）建立连接，7号就会把该连接放进链表里，等待 redis 轮训 epoll_wait 获得返回结果，当 redis 从链表中拿到客户端想要连接后，调用 accept 进行接收会获得一个连接的文件描述符8，并设置成非阻塞然后调用 epoll_ctl 把8放进5的红黑树里面。此时 epoll_wait 的轮训：即有想要连接的请求，也有要发送数据的请求。

当有连接或者数据进来的时候，经过网卡，会产生中断信号，此时cpu就会把7或者8放到链表里（也就是触发了事件），由用户程序 epoll_wait 去循环接收，然后处理。
</code></pre></div><h3 id="bytebuffer"><a href="#bytebuffer" class="header-anchor">#</a> ByteBuffer</h3> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">RandomAccessFile</span> accessFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token string">&quot;D:\\test1.txt&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        accessFile<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;hello world\nhello mashibing\ngood idea&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在指定文件偏移量的位置添加ooxx，原来的数据被替换</span>
        accessFile<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessFile<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;ooxx&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//在堆上分配空间（在java进程里面，受Xmx配置的影响）</span>
        <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//在堆外分配空间（在java进程里面）</span>
        <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">FileChannel</span> fileChannel <span class="token operator">=</span> accessFile<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 在堆外的MMAP上分配（在java进程外面）（只有文件才可以分配这样的区域）</span>
        <span class="token class-name">MappedByteBuffer</span> mappedByteBuffer <span class="token operator">=</span> fileChannel<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">FileChannel</span><span class="token punctuation">.</span><span class="token class-name">MapMode</span><span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 会直接落到文件：从给指定偏移的位置开始添加，会替换要添加数据的长度的位置</span>
        <span class="token comment">// 1、如果要添加的数据长度超过了4096，就会报java.nio.BufferOverflowException</span>
        <span class="token comment">// 2、如果小于4096且大于原文件从偏移位置到文件末尾的长度，则会替换从偏移位置开始到文件末尾的所有数据，并从偏移位置开始占有4096个字节</span>
        <span class="token comment">// 3、如果小于4096且小于源文件从偏移位置到文件末尾的长度，则会替换从偏移位置开始，到数据长度的位置结束，后面的不会替换，但是从偏移位置开始仍然占有4096个字节</span>
        mappedByteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="mmap"><a href="#mmap" class="header-anchor">#</a> MMAP</h2> <blockquote><p>一种内存映射文件的方法</p></blockquote> <ol><li><p>java把class load到内存其位置实际是在jvm的堆空间。堆空间存放一些object，data等。</p></li> <li><p>内核获取进程外的东西，非常方便；但是要想获取java堆空间的数据，需要先经过jvm，中间多了一层逻辑转换。</p></li> <li><p>java也有堆外空间（使用 unsafe 进行访问），堆外空间只能存储 byte，不需要jvm翻译，比堆内更快</p></li> <li><p>堆外开辟空间，让它和内核共享一块内存，可以使用 mmap来划分，多线程可以同时访问这块区域，同时可以映射到磁盘的文件。使用 mapbuffer（磁盘buffer） 的 put，之后就直接到文件了。</p> <p>RandomAccesseFile(filepath).map(4096) =&gt; mapbuffer.put</p></li> <li><p>kafka：数据从网卡进来，经过内核达到 kafka（recive），增加头部，然后通过mmap直接映射到文件，充分利用磁盘的顺序读写（会形成很多断文件），当缓存中满了，就falsh到磁盘。</p></li> <li><p>内核有一个 sendfile 的系统调用，可以由用户程序直接调用该系统调用（一般由是由框架封装的API），读取文件的时候，就不需要在经过一个用户空间的拷贝，故称零拷贝。</p></li></ol> <h2 id="顺序写入、mmap"><a href="#顺序写入、mmap" class="header-anchor">#</a> 顺序写入、MMAP</h2> <p>​		Memory Mapped Files(后面简称mmap)也称为内存映射文件，在64位操作系统中一般可以表示20G的数据文件，它的工作原理是直接利用操作系统的Page实现文件到物理内存的直接映射。完成MMP映射后，用户对内存的所有操作会被操作系统自动的刷新到磁盘上，极大地降低了IO使用率。</p> <p><img src="/images/%E9%A1%BA%E5%BA%8F%E5%86%99%E5%85%A5%E5%92%8CMMAPpng.png" alt="顺序写入和MMAPpng"></p> <h2 id="zero拷贝"><a href="#zero拷贝" class="header-anchor">#</a> Zero拷贝</h2> <p>ZeroCopy技术，直接将磁盘无需拷贝到用户空间，而是直接将数据通过内核空间传递输出，数据并没有抵达用户空间。</p> <p><strong>传统IO操作</strong></p> <ol><li><p>用户进程调用read等系统调用向操作系统发出IO请求，请求读取数据到自己的内存缓冲区中。自己进入阻塞状态。</p></li> <li><p>操作系统收到请求后，进一步将IO请求发送磁盘。</p></li> <li><p>磁盘驱动器收到内核的IO请求，把数据从磁盘读取到驱动器的缓冲中。此时不占用CPU。当驱动器的缓冲区被读满后，向内核发起中断信号告知自己缓冲区已满。</p></li> <li><p>内核收到中断，使用CPU时间将磁盘驱动器的缓存中的数据拷贝到内核缓冲区中。</p></li> <li><p>如果内核缓冲区的数据少于用户申请的读的数据，重复步骤3跟步骤4，直到内核缓冲区的数据足够多为止。</p></li> <li><p>将数据从内核缓冲区拷贝到用户缓冲区，同时从系统调用中返回。完成任务</p> <p><img src="/images/%E4%BC%A0%E7%BB%9FIO%E6%93%8D%E4%BD%9C.png" alt="传统IO操作"></p> <p><img src="/images/%E4%BC%A0%E7%BB%9FIO%E7%BD%91%E7%BB%9C%E5%9B%BE%E8%A7%A3.png" alt="传统IO网络图解"></p></li></ol> <p><strong>DMA读取</strong></p> <ol><li><p>用户进程调用read等系统调用向操作系统发出IO请求，请求读取数据到自己的内存缓冲区中。自己进入阻塞状态。</p></li> <li><p>操作系统收到请求后，进一步将IO请求发送DMA。然后让CPU干别的活去。</p></li> <li><p>DMA进一步将IO请求发送给磁盘。</p></li> <li><p>磁盘驱动器收到DMA的IO请求，把数据从磁盘读取到驱动器的缓冲中。当驱动器的缓冲区被读满后，向DMA发起中断信号告知自己缓冲区已满。</p></li> <li><p>DMA收到磁盘驱动器的信号，将磁盘驱动器的缓存中的数据拷贝到内核缓冲区中。此时不占用CPU。这个时候只要内核缓冲区的数据少于用户申请的读的数据，内核就会一直重复步骤3跟步骤4，直到内核缓冲区的数据足够多为止。</p></li> <li><p>当DMA读取了足够多的数据，就会发送中断信号给CPU。</p></li> <li><p>CPU收到DMA的信号，知道数据已经准备好，于是将数据从内核拷贝到用户空间，系统调用返回。</p> <p><img src="/images/DMA%E8%AF%BB%E5%8F%96.png" alt="DMA读取"></p> <p><img src="/images/Zero%E6%8B%B7%E8%B4%9D%E7%BD%91%E7%BB%9C%E5%9B%BE.png" alt="Zero拷贝网络图"></p></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/27/2020, 4:01:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tiankafei-docs-java/JVM从入门到精通.html" class="prev">
        JVM入门到精通
      </a></span> <span class="next"><a href="/tiankafei-docs-java/Lambda表达式和StreamAPI用法.html">
        Lambda表达式中，常用的接口
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f48ead2e.js" defer></script><script src="/assets/js/2.d3d861b7.js" defer></script><script src="/assets/js/28.0afbf7d8.js" defer></script>
  </body>
</html>
