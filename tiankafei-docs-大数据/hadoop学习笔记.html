<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>大数据启蒙 | tiankafei - java相关技术栈</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="自己写的一些东西的记录，包括代码与笔记，jdk最低支持1.8">
    <link rel="preload" href="/assets/css/0.styles.abfd12c2.css" as="style"><link rel="preload" href="/assets/js/app.5c6b7722.js" as="script"><link rel="preload" href="/assets/js/2.39facb6e.js" as="script"><link rel="preload" href="/assets/js/81.81ada22d.js" as="script"><link rel="prefetch" href="/assets/js/10.a56b0851.js"><link rel="prefetch" href="/assets/js/100.c8e707f9.js"><link rel="prefetch" href="/assets/js/101.0a4b73f2.js"><link rel="prefetch" href="/assets/js/11.a35a4ec8.js"><link rel="prefetch" href="/assets/js/12.ac182dca.js"><link rel="prefetch" href="/assets/js/13.0453e958.js"><link rel="prefetch" href="/assets/js/14.7c658258.js"><link rel="prefetch" href="/assets/js/15.8d786292.js"><link rel="prefetch" href="/assets/js/16.30c9b812.js"><link rel="prefetch" href="/assets/js/17.2c2f8db6.js"><link rel="prefetch" href="/assets/js/18.2fb338ff.js"><link rel="prefetch" href="/assets/js/19.242fe208.js"><link rel="prefetch" href="/assets/js/20.e771fe47.js"><link rel="prefetch" href="/assets/js/21.284e8060.js"><link rel="prefetch" href="/assets/js/22.e3631711.js"><link rel="prefetch" href="/assets/js/23.6086a5a3.js"><link rel="prefetch" href="/assets/js/24.82a6f54a.js"><link rel="prefetch" href="/assets/js/25.fa9d7141.js"><link rel="prefetch" href="/assets/js/26.4805662a.js"><link rel="prefetch" href="/assets/js/27.dca40bfd.js"><link rel="prefetch" href="/assets/js/28.cfaa8f77.js"><link rel="prefetch" href="/assets/js/29.c89b81ae.js"><link rel="prefetch" href="/assets/js/3.e5ac4b1f.js"><link rel="prefetch" href="/assets/js/30.391d6663.js"><link rel="prefetch" href="/assets/js/31.a945fc3a.js"><link rel="prefetch" href="/assets/js/32.17830a35.js"><link rel="prefetch" href="/assets/js/33.990b8fd2.js"><link rel="prefetch" href="/assets/js/34.75b609b1.js"><link rel="prefetch" href="/assets/js/35.25bb4dcf.js"><link rel="prefetch" href="/assets/js/36.48a34f1b.js"><link rel="prefetch" href="/assets/js/37.aa35fb6a.js"><link rel="prefetch" href="/assets/js/38.f27e1e5a.js"><link rel="prefetch" href="/assets/js/39.90efc18e.js"><link rel="prefetch" href="/assets/js/4.3b6a7e49.js"><link rel="prefetch" href="/assets/js/40.65757661.js"><link rel="prefetch" href="/assets/js/41.3f125335.js"><link rel="prefetch" href="/assets/js/42.035652a7.js"><link rel="prefetch" href="/assets/js/43.68431f66.js"><link rel="prefetch" href="/assets/js/44.bc608b46.js"><link rel="prefetch" href="/assets/js/45.0a604d95.js"><link rel="prefetch" href="/assets/js/46.578bc18a.js"><link rel="prefetch" href="/assets/js/47.3874230e.js"><link rel="prefetch" href="/assets/js/48.30bcfe5f.js"><link rel="prefetch" href="/assets/js/49.d954b8d3.js"><link rel="prefetch" href="/assets/js/5.af75ae8c.js"><link rel="prefetch" href="/assets/js/50.d07aff26.js"><link rel="prefetch" href="/assets/js/51.4c85c646.js"><link rel="prefetch" href="/assets/js/52.c0145ca7.js"><link rel="prefetch" href="/assets/js/53.85951f4f.js"><link rel="prefetch" href="/assets/js/54.a754792e.js"><link rel="prefetch" href="/assets/js/55.5039623f.js"><link rel="prefetch" href="/assets/js/56.b73f51a9.js"><link rel="prefetch" href="/assets/js/57.7ebe5099.js"><link rel="prefetch" href="/assets/js/58.7d1241f0.js"><link rel="prefetch" href="/assets/js/59.60c425c8.js"><link rel="prefetch" href="/assets/js/6.0132adf5.js"><link rel="prefetch" href="/assets/js/60.e3f475a1.js"><link rel="prefetch" href="/assets/js/61.cd7bf899.js"><link rel="prefetch" href="/assets/js/62.4ebf1932.js"><link rel="prefetch" href="/assets/js/63.c1ce6611.js"><link rel="prefetch" href="/assets/js/64.fba3fed9.js"><link rel="prefetch" href="/assets/js/65.f46996ea.js"><link rel="prefetch" href="/assets/js/66.7cc1344d.js"><link rel="prefetch" href="/assets/js/67.b017655f.js"><link rel="prefetch" href="/assets/js/68.456b1e70.js"><link rel="prefetch" href="/assets/js/69.e683fd8b.js"><link rel="prefetch" href="/assets/js/7.8ce782ff.js"><link rel="prefetch" href="/assets/js/70.ec773f75.js"><link rel="prefetch" href="/assets/js/71.ba5ed53c.js"><link rel="prefetch" href="/assets/js/72.9a25eddc.js"><link rel="prefetch" href="/assets/js/73.94c59a5a.js"><link rel="prefetch" href="/assets/js/74.2aab3c45.js"><link rel="prefetch" href="/assets/js/75.720a4a0c.js"><link rel="prefetch" href="/assets/js/76.c20aeb36.js"><link rel="prefetch" href="/assets/js/77.de40de45.js"><link rel="prefetch" href="/assets/js/78.7d00ebf3.js"><link rel="prefetch" href="/assets/js/79.f955c367.js"><link rel="prefetch" href="/assets/js/8.f99b10ac.js"><link rel="prefetch" href="/assets/js/80.09382174.js"><link rel="prefetch" href="/assets/js/82.d6deca45.js"><link rel="prefetch" href="/assets/js/83.9c966bdc.js"><link rel="prefetch" href="/assets/js/84.0cde69a4.js"><link rel="prefetch" href="/assets/js/85.021e0d1f.js"><link rel="prefetch" href="/assets/js/86.1b584f09.js"><link rel="prefetch" href="/assets/js/87.d1ddaa6a.js"><link rel="prefetch" href="/assets/js/88.bd515ad0.js"><link rel="prefetch" href="/assets/js/89.23504f19.js"><link rel="prefetch" href="/assets/js/9.7016d517.js"><link rel="prefetch" href="/assets/js/90.851f11fb.js"><link rel="prefetch" href="/assets/js/91.381277d8.js"><link rel="prefetch" href="/assets/js/92.b6dffe28.js"><link rel="prefetch" href="/assets/js/93.6f262915.js"><link rel="prefetch" href="/assets/js/94.d46a37ed.js"><link rel="prefetch" href="/assets/js/95.b69b22cb.js"><link rel="prefetch" href="/assets/js/96.173339f1.js"><link rel="prefetch" href="/assets/js/97.ea0de7e9.js"><link rel="prefetch" href="/assets/js/98.929add45.js"><link rel="prefetch" href="/assets/js/99.936ebdc6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.abfd12c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">tiankafei - java相关技术栈</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/tiankafei-docs-java/Java基础.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/tiankafei-docs-spring/spring学习笔记/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/tiankafei-docs-架构/MySQL调优/" class="nav-link">
  架构
</a></div><div class="nav-item"><a href="/tiankafei-docs-大数据/centos7安装配置Hadoop/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/tiankafei-docs-linux/centos常用命令/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/tiankafei-docs-云/Centos7安装Docker并配置使用/" class="nav-link">
  云
</a></div><div class="nav-item"><a href="/tiankafei-docs-other/git上fork后再更新/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/tiankafei-docs-en/词性语法学习/" class="nav-link">
  英语
</a></div><div class="nav-item"><a href="https://github.com/tiankafei/tiankafei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/tiankafei-docs-java/Java基础.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/tiankafei-docs-spring/spring学习笔记/" class="nav-link">
  Spring
</a></div><div class="nav-item"><a href="/tiankafei-docs-架构/MySQL调优/" class="nav-link">
  架构
</a></div><div class="nav-item"><a href="/tiankafei-docs-大数据/centos7安装配置Hadoop/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/tiankafei-docs-linux/centos常用命令/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/tiankafei-docs-云/Centos7安装Docker并配置使用/" class="nav-link">
  云
</a></div><div class="nav-item"><a href="/tiankafei-docs-other/git上fork后再更新/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/tiankafei-docs-en/词性语法学习/" class="nav-link">
  英语
</a></div><div class="nav-item"><a href="https://github.com/tiankafei/tiankafei" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>大数据</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tiankafei-docs-大数据/centos7安装配置Hadoop.html" class="sidebar-link">CentOS7安装Hadoop</a></li><li><a href="/tiankafei-docs-大数据/hadoop学习笔记.html" class="active sidebar-link">大数据启蒙</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#分治思想1：查找" class="sidebar-link">分治思想1：查找</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#需求" class="sidebar-link">需求</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#如果查找某一个元素是否在这个集合当中，最简单的遍历方式复杂的是多少" class="sidebar-link">如果查找某一个元素是否在这个集合当中，最简单的遍历方式复杂的是多少</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#如果查找某一个元素是否在这个集合当中，我期望复杂度是o-4-呢" class="sidebar-link">如果查找某一个元素是否在这个集合当中，我期望复杂度是O(4)呢</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#分治思想的应用案例" class="sidebar-link">分治思想的应用案例</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#分治思想2：找重复的行" class="sidebar-link">分治思想2：找重复的行</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#需求-2" class="sidebar-link">需求</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#单机分治解决" class="sidebar-link">单机分治解决</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#集群解决" class="sidebar-link">集群解决</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#分析" class="sidebar-link">分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#结论" class="sidebar-link">结论</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#hdfs" class="sidebar-link">HDFS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#存储模型" class="sidebar-link">存储模型</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#架构设计" class="sidebar-link">架构设计</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#角色功能" class="sidebar-link">角色功能</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#数据持久化的几种实现方式" class="sidebar-link">数据持久化的几种实现方式</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#元数据持久化" class="sidebar-link">元数据持久化</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#安全模式" class="sidebar-link">安全模式</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#hdfs中的snn" class="sidebar-link">HDFS中的SNN</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#block的副本放置策略" class="sidebar-link">Block的副本放置策略</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#hdfs写流程" class="sidebar-link">HDFS写流程</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#hdfs读流程" class="sidebar-link">HDFS读流程</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#api" class="sidebar-link">API</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#mapreduce" class="sidebar-link">MapReduce</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#map映射" class="sidebar-link">Map映射</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#reduce分组计算" class="sidebar-link">Reduce分组计算</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#mapreduce-2" class="sidebar-link">MapReduce</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#mapreduce详细的计算过程" class="sidebar-link">MapReduce详细的计算过程</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#mapreduce详细拆解过程" class="sidebar-link">MapReduce详细拆解过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#计算向数据移动" class="sidebar-link">计算向数据移动</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#client" class="sidebar-link">Client</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#jobtracker" class="sidebar-link">JobTracker</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#tasktracker" class="sidebar-link">TaskTracker</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#yarn：资源管理" class="sidebar-link">Yarn：资源管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#架构图" class="sidebar-link">架构图</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#模型" class="sidebar-link">模型</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#client源码分析" class="sidebar-link">Client源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#默认输入格式化类" class="sidebar-link">默认输入格式化类</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#计算切片" class="sidebar-link">计算切片</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#上传切片清单和配置" class="sidebar-link">上传切片清单和配置</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#maptask源码分析" class="sidebar-link">MapTask源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#map主要流程：maptask-run" class="sidebar-link">Map主要流程：MapTask.run();</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#前置参数组装：maptask-runnewmapper" class="sidebar-link">前置参数组装：MapTask.runNewMapper();</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#map的run方法" class="sidebar-link">Map的run方法</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#recordreader初始化对于切割字符串的处理" class="sidebar-link">RecordReader初始化对于切割字符串的处理</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#recordreader的nextkeyvalue方法" class="sidebar-link">RecordReader的nextKeyValue方法</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#map输出的处理：创建分区器" class="sidebar-link">Map输出的处理：创建分区器</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#map输出的缓冲区初始化：mapoutputbuffer-init" class="sidebar-link">Map输出的缓冲区初始化：MapOutputBuffer.init</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#map输出的处理：spillthread溢写线程" class="sidebar-link">Map输出的处理：SpillThread溢写线程</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#map输出的处理：context-write-key-value" class="sidebar-link">Map输出的处理：context.write(key, value);</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#map输出的缓冲区：mapoutputbuffer" class="sidebar-link">Map输出的缓冲区：MapOutputBuffer</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#reducetask源码分析" class="sidebar-link">ReduceTask源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#reduce主要流程：" class="sidebar-link">Reduce主要流程：</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#前置参数组装：reducetask-runnewreducer" class="sidebar-link">前置参数组装：ReduceTask.runNewReducer();</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#reduce的context-nextkeyvalue" class="sidebar-link">Reduce的context.nextKeyValue()</a></li></ul></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#mapreduce的java实现" class="sidebar-link">MapReduce的Java实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#wordcount" class="sidebar-link">WordCount</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#topn" class="sidebar-link">TopN</a></li><li class="sidebar-sub-header"><a href="/tiankafei-docs-大数据/hadoop学习笔记.html#大数据思维模式" class="sidebar-link">大数据思维模式</a></li></ul></li></ul></li><li><a href="/tiankafei-docs-大数据/Hadoop程序运行的三种方式.html" class="sidebar-link">Hadoop程序运行的三种方式</a></li><li><a href="/tiankafei-docs-大数据/hive学习笔记.html" class="sidebar-link">Hive学习笔记</a></li><li><a href="/tiankafei-docs-大数据/centos7安装配置HBase.html" class="sidebar-link">centos7安装配置HBase</a></li><li><a href="/tiankafei-docs-大数据/hbase学习笔记.html" class="sidebar-link">HBase学习笔记</a></li><li><a href="/tiankafei-docs-大数据/大数据项目-日志收集分析.html" class="sidebar-link">大数据项目-日志收集分析</a></li><li><a href="/tiankafei-docs-大数据/flume学习笔记.html" class="sidebar-link">Flume</a></li><li><a href="/tiankafei-docs-大数据/sqoop学习笔记.html" class="sidebar-link">sqoop的简单概论</a></li><li><a href="/tiankafei-docs-大数据/centos7安装配置Spark.html" class="sidebar-link">Centos7安装Scala</a></li><li><a href="/tiankafei-docs-大数据/scala学习笔记.html" class="sidebar-link">Scala学习</a></li><li><a href="/tiankafei-docs-大数据/centos7安装配置Flink.html" class="sidebar-link">Centos7安装Flink</a></li><li><a href="/tiankafei-docs-大数据/Kafka学习笔记.html" class="sidebar-link">Kafka</a></li><li><a href="/tiankafei-docs-大数据/距离度量.html" class="sidebar-link">欧式距离</a></li><li><a href="/tiankafei-docs-大数据/导数.html" class="sidebar-link">/tiankafei-docs-大数据/导数.html</a></li><li><a href="/tiankafei-docs-大数据/概率.html" class="sidebar-link">/tiankafei-docs-大数据/概率.html</a></li><li><a href="/tiankafei-docs-大数据/逻辑.html" class="sidebar-link">/tiankafei-docs-大数据/逻辑.html</a></li><li><a href="/tiankafei-docs-大数据/线性代数.html" class="sidebar-link">/tiankafei-docs-大数据/线性代数.html</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="大数据启蒙"><a href="#大数据启蒙" class="header-anchor">#</a> 大数据启蒙</h1> <h2 id="分治思想1：查找"><a href="#分治思想1：查找" class="header-anchor">#</a> 分治思想1：查找</h2> <h3 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h3> <div class="language- extra-class"><pre class="language-text"><code>我有一万个元素（比如数字或单词）需要存储
</code></pre></div><h3 id="如果查找某一个元素是否在这个集合当中，最简单的遍历方式复杂的是多少"><a href="#如果查找某一个元素是否在这个集合当中，最简单的遍历方式复杂的是多少" class="header-anchor">#</a> 如果查找某一个元素是否在这个集合当中，最简单的遍历方式复杂的是多少</h3> <p><img src="/images/%E5%88%86%E6%B2%BB%E6%80%9D%E6%83%B31-1.png" alt="分治思想1-1"></p> <h3 id="如果查找某一个元素是否在这个集合当中，我期望复杂度是o-4-呢"><a href="#如果查找某一个元素是否在这个集合当中，我期望复杂度是o-4-呢" class="header-anchor">#</a> 如果查找某一个元素是否在这个集合当中，我期望复杂度是O(4)呢</h3> <p><img src="/images/%E5%88%86%E6%B2%BB%E6%80%9D%E6%83%B31-2.png" alt="分治思想1-2"></p> <h2 id="分治思想的应用案例"><a href="#分治思想的应用案例" class="header-anchor">#</a> 分治思想的应用案例</h2> <ol><li>Redis集群</li> <li>ElasticSearch</li> <li>Hbase</li> <li>HADOOP生态无处不在！</li> <li>......</li></ol> <h2 id="分治思想2：找重复的行"><a href="#分治思想2：找重复的行" class="header-anchor">#</a> 分治思想2：找重复的行</h2> <h3 id="需求-2"><a href="#需求-2" class="header-anchor">#</a> 需求</h3> <div class="language- extra-class"><pre class="language-text"><code>有一个非常大的文本文件1T，里面有很多很多的行，只有两行一样，它们出现在未知的位置，需要查找到它们。
假设Io速度是500MB每秒
网络IO速度是100MB每秒
</code></pre></div><h3 id="单机分治解决"><a href="#单机分治解决" class="header-anchor">#</a> 单机分治解决</h3> <ol><li>单机内存不可能放得下1T的文件，故需要对此文件进行拆解；</li> <li>读取文件，每读一行，求该行的 hashcode 然后%2000，可以把1T的数据分成2000份（每份大小500M），相同的行肯定在同一个文件中；</li> <li>依次遍历2000个文件，找到重复的行。</li></ol> <p><strong>用时分析：</strong></p> <ol><li>1T文件读取一遍需要约30分钟</li> <li>然后再次遍历2000个小文件，假如重复的行在最后一个文件里，依然需要30分钟</li></ol> <h3 id="集群解决"><a href="#集群解决" class="header-anchor">#</a> 集群解决</h3> <ol><li>读取文件，每读一行，求该行的 hashcode 然后%2000，可以把1T的数据分成2000份（每份大小500M），相同的行肯定在同一个文件中；</li> <li>把这2000个小文件分发到2000台机器上</li> <li>2000台机器拿到文件后一起进行计算</li></ol> <p><strong>用时分析：</strong></p> <ol><li>1T文件读取一遍需要约30分钟</li> <li>2000个小文件（1T）分发到2000台机器上需要5个30分钟，也就是两个半小时</li> <li>2000台机器一起执行计算，用时1秒钟</li></ol> <h3 id="分析"><a href="#分析" class="header-anchor">#</a> 分析</h3> <ol><li>此时集群的2000台机器还没有1台单机的处理速度快</li> <li>但是：如果考虑每天都有1T的数据产生呢？如果增量了一年，最后一天计算数据呢？
<ol><li>第一天的时候，单机需要用1个小时，集群需要用3个小时零1秒</li> <li>第二天的时候，单机需要用2个小时，集群需要用3个小时零2秒（第一天的1T已经分发出去了，只需要分发当天增量的1T数据即可）</li> <li>第三天的时候，单机需要3个小时，集群需要用3个小时零3秒（只需要分发当前增量的1T数据），近似已经追平了</li> <li>第四天的时候，单机需要4个小时，集群需要用3个小时零4秒（只需要分发当前增量的1T数据），已经完胜了</li> <li>......</li> <li>第365天的时候，单机需要365个小时（近半个月），集群需要用3个小时零365秒，完胜。</li></ol></li></ol> <h2 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h2> <ol><li>分而治之</li> <li>并行计算</li> <li>计算向数据移动（计算找数据）</li> <li>数据本地化读取</li></ol> <h1 id="hadoop"><a href="#hadoop" class="header-anchor">#</a> Hadoop</h1> <h2 id="hdfs"><a href="#hdfs" class="header-anchor">#</a> HDFS</h2> <blockquote><p><strong>分布式文件系统那么多，为什么hadoop项目还要开发一个hdfs文件系统？</strong></p> <ol><li><strong>分布式存储为了更好的分布式计算</strong></li> <li><strong>一个文件被分成多个相同大小的 block 块，便于同时读取不同的 block 块（计算向数据移动），增加并行度</strong></li> <li><strong>数据的可靠性有保障</strong></li> <li><strong>Hdfs支持client给出文件的offset自定义连接哪些block的DN，自定义获取数据</strong></li> <li><strong>支持新增，追加，删除，查询，唯独不支持更新</strong></li></ol></blockquote> <h3 id="存储模型"><a href="#存储模型" class="header-anchor">#</a> 存储模型</h3> <ol><li>文件线性按字节切割成块(block)，具有offset，id</li> <li>文件与文件的block大小可以不一样</li> <li>一个文件除最后一个block，其他block大小一致</li> <li>block的大小依据硬件的I/O特性调整</li> <li>block被分散存放在集群的节点中，具有location（位置定位信息）</li> <li>Block具有副本(replication)，没有主从概念，副本不能出现在同一个节点</li> <li>副本是满足可靠性和性能的关键</li> <li>文件上传可以指定block大小和副本数，上传后只能修改副本数</li> <li>一次写入多次读取，不支持修改</li> <li>支持追加数据</li></ol> <p><img src="/images/hdfs%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B.gif" alt="hdfs存储模型"></p> <h3 id="架构设计"><a href="#架构设计" class="header-anchor">#</a> 架构设计</h3> <ol><li>HDFS是一个主从(Master/Slaves)架构</li> <li>由一个NameNode和一些DataNode组成</li> <li>面向文件包含：文件数据(data)和文件元数据(metadata)</li> <li>NameNode负责存储和管理文件元数据，并维护了一个层次型的文件目录树</li> <li>DataNode负责存储文件数据(block块)，并提供block的读写</li> <li>DataNode与NameNode维持心跳，并汇报自己持有的block信息</li> <li>Client和NameNode交互文件元数据和DataNode交互文件block数据</li></ol> <p><img src="/images/hdfs.gif" alt="hdfs"></p> <h3 id="角色功能"><a href="#角色功能" class="header-anchor">#</a> 角色功能</h3> <h4 id="namenode"><a href="#namenode" class="header-anchor">#</a> NameNode</h4> <ol><li>完全基于内存存储文件元数据、目录结构、文件block的映射</li> <li>需要持久化方案保证数据可靠性</li> <li>提供副本放置策略</li></ol> <h4 id="datanode"><a href="#datanode" class="header-anchor">#</a> DataNode</h4> <ol><li>基于本地磁盘存储block(文件的形式)</li> <li>并保存block的校验和数据保证block的可靠性</li> <li>与NameNode保持心跳，汇报block列表状态</li></ol> <h3 id="数据持久化的几种实现方式"><a href="#数据持久化的几种实现方式" class="header-anchor">#</a> 数据持久化的几种实现方式</h3> <h4 id="日志"><a href="#日志" class="header-anchor">#</a> 日志</h4> <ol><li>日志文件记录实时发生的增删改操作</li> <li>完成性比较好</li> <li>加载恢复数据慢，占用很大空间</li></ol> <h4 id="镜像"><a href="#镜像" class="header-anchor">#</a> 镜像</h4> <ol><li>间隔（一段时间），内存全量数据基于某一时刻做的向磁盘的溢写</li> <li>如果时间间隔很短的情况下，IO就会很频繁，如果内存数据量大的话，也会很慢</li> <li>因为是间隔的，容易丢失一部分数据</li></ol> <h3 id="元数据持久化"><a href="#元数据持久化" class="header-anchor">#</a> 元数据持久化</h3> <blockquote><p>数据持久化方式：日志（EditLog） + 镜像（FsImage）</p></blockquote> <ol><li>任何对文件系统元数据产生修改的操作，Namenode都会使用一种称为EditLog的事务日志记录下来</li> <li>使用FsImage存储内存所有的元数据状态</li> <li>使用本地磁盘保存EditLog和FsImage</li> <li>EditLog具有完整性，数据丢失少，但恢复速度慢，并有体积膨胀风险</li> <li>FsImage具有恢复速度快，体积与内存数据相当，但不能实时保存，数据丢失多</li> <li><strong>NameNode使用了FsImage+EditLog整合的方案：</strong> <ul><li>滚动将增量的EditLog更新到FsImage，以保证更近时点的FsImage和更小的EditLog体积</li></ul></li> <li><strong>在持久化EditLog的时候，文件的属性信息会进行持久化，块的元数据不会进行持久化</strong>。等待datanode来汇报。</li></ol> <blockquote><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">cd</span> ./local/dfs/name/current
<span class="token comment"># 观察 editlog的id是不是再fsimage的后边</span>
<span class="token builtin class-name">cd</span> ./local/dfs/secondary/current
<span class="token comment"># SNN 只需要从NN拷贝最后时点的FSimage和增量的Editlog</span>
<span class="token builtin class-name">cd</span> ./local/dfs/data/current/BP-281147636-192.168.150.11-1560691854170/current/finalized/subdir0/subdir0
<span class="token comment"># 检查data.txt被切割的块，他们数据什么样子</span>
</code></pre></div></blockquote> <h3 id="安全模式"><a href="#安全模式" class="header-anchor">#</a> 安全模式</h3> <ol><li>HDFS搭建时会格式化，格式化操作会产生一个空的FsImage</li> <li>当Namenode启动时，它从硬盘中读取Editlog和FsImage</li> <li>将所有Editlog中的事务作用在内存中的FsImage上</li> <li>并将这个新版本的FsImage从内存中保存到本地磁盘上</li> <li>然后删除旧的Editlog，因为这个旧的Editlog的事务都已经作用在FsImage上了，所以此时的FsImage已经是最新的全量数据了</li> <li><strong>Namenode启动后会进入一个称为安全模式的特殊状态。</strong></li> <li>处于安全模式的Namenode是不会进行数据块的复制的。</li> <li>Namenode从所有的 Datanode接收心跳信号和块状态报告。</li> <li>每当Namenode检测确认某个数据块的副本数目达到这个最小值，那么该数据块就会被认为是副本安全(safely replicated)的。</li> <li><strong>在一定百分比（这个参数可配置）的数据块被Namenode检测确认是安全之后</strong>（如果有些datanode一直起不起来，加上一个额外的30秒等待时间），Namenode将退出安全模式状态。</li> <li><strong>接下来它会确定还有哪些数据块的副本没有达到指定数目，并将这些数据块复制到其他Datanode上。</strong></li></ol> <h3 id="hdfs中的snn"><a href="#hdfs中的snn" class="header-anchor">#</a> HDFS中的SNN</h3> <blockquote><p>SecondaryNameNode（SNN）</p></blockquote> <ol><li>在非Ha模式下，SNN一般是独立的节点，周期完成对NN的EditLog向FsImage合并，减少EditLog大小，减少NN启动时间</li> <li>根据配置文件设置的时间间隔fs.checkpoint.period  默认3600秒</li> <li>根据配置文件设置edits log大小 fs.checkpoint.size 规定edits文件的最大值默认是64MB</li></ol> <p><img src="/images/%E9%9D%9EHa%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84SecondaryNameNode.png" alt="非Ha模式下的SecondaryNameNode"></p> <h3 id="block的副本放置策略"><a href="#block的副本放置策略" class="header-anchor">#</a> Block的副本放置策略</h3> <blockquote><p>1.x的时候，第二个副本和第一个副本在同一个机架，第三个副本才会出机架</p> <p>2.x的时候，第二个副本就已经出机架了，第三个副本和第二个副本同一个机架，（第三个副本和第二个副本在同一机架，可以减少网络IO）</p></blockquote> <ol><li>第一个副本：放置在上传文件的DN；如果是集群外提交，则随机挑选一台磁盘不太满，CPU不太忙的节点。</li> <li>第二个副本：放置在于第一个副本不同的 机架的节点上。</li> <li>第三个副本：与第二个副本相同机架的节点。</li> <li>更多副本：随机节点。</li></ol> <h3 id="hdfs写流程"><a href="#hdfs写流程" class="header-anchor">#</a> HDFS写流程</h3> <p><img src="/images/HDFS%E5%86%99%E6%B5%81%E7%A8%8B.png" alt="HDFS写流程"></p> <ol><li>Client和NN连接创建文件元数据</li> <li>NN判定元数据是否有效（是否已经存在，是否有权限）</li> <li>NN触发副本放置策略，返回一个有序的DN列表</li> <li>Client和DN建立Pipeline连接（小字节传输，支持最大力度的并行，类似流水线）</li> <li>Client将块切分成packet（64KB），并使用chunk数据的字节（512B）+chucksum校验盒（4B）填充</li> <li>Client将packet放入发送队列dataqueue中，并向第一个DN发送</li> <li>第一个DN收到packet后本地保存并发送给第二个DN</li> <li>第二个DN收到packet后本地保存并发送给第三个DN</li> <li>这一个过程中，上游节点同时发送下一个packet</li> <li><strong>生活中类比工厂的流水线：结论：流式其实也是变种的并行计算</strong></li> <li>Hdfs使用这种传输方式，副本数对于client是透明的</li> <li>当block传输完成，DN们各自向NN汇报，同时client继续传输下一个block</li> <li>所以，client的传输和block的汇报也是并行的</li></ol> <blockquote><p>如果中间有datanode挂掉了，则直接跳过该datanode往后传输，等传输完成之后，datanode会给namenode汇报block信息，如果和副本数量不一致，则namenode会触发副本放置策略。</p></blockquote> <h3 id="hdfs读流程"><a href="#hdfs读流程" class="header-anchor">#</a> HDFS读流程</h3> <p><img src="/images/HDFS%E8%AF%BB%E6%B5%81%E7%A8%8B.png" alt="HDFS读流程"></p> <ol><li>为了降低整体的带宽消耗和读取延时，HDFS会尽量让读取程序读取离它最近的副本。</li> <li>如果在读取程序的同一个机架上有一个副本，那么就读取该副本。</li> <li>如果一个HDFS集群跨越多个数据中心，那么客户端也将首先读本地数据中心的副本。</li> <li>语义：下载一个文件：
<ol><li>Client和NN交互文件元数据获取fileBlockLocation</li> <li>NN会按距离策略排序返回</li> <li>Client尝试下载block并校验数据完整性</li></ol></li> <li>语义：下载一个文件其实是获取文件的所有的block元数据，那么子集获取某些block应该成立
<ol><li>Hdfs支持client给出文件的offset自定义连接哪些block的DN，自定义获取数据</li> <li>这个是支持计算层的分治、并行计算的核心</li></ol></li></ol> <h3 id="api"><a href="#api" class="header-anchor">#</a> API</h3> <h4 id="环境权限"><a href="#环境权限" class="header-anchor">#</a> 环境权限</h4> <div class="language- extra-class"><pre class="language-text"><code>1）参考系统登录用户名；登陆用户名改为root
2）参考环境变量；HADOOP_USER_NAME=root
3）代码中给出；System.setProperty(&quot;HADOOP_USER_NAME&quot;, &quot;root&quot;);
</code></pre></div><h4 id="初始化依赖环境"><a href="#初始化依赖环境" class="header-anchor">#</a> 初始化依赖环境</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Before</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">URI</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URI</span><span class="token punctuation">(</span><span class="token string">&quot;hdfs://mycluster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs <span class="token operator">=</span> <span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="创建hdfs目录"><a href="#创建hdfs目录" class="header-anchor">#</a> 创建hdfs目录</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/user/root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    fs<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="上传文件"><a href="#上传文件" class="header-anchor">#</a> 上传文件</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Path</span> remoteFilePath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;hdfs路径&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>remoteFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>remoteFilePath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">FileInputStream</span> fileInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">BufferedInputStream</span> bufferedInputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fileInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">&quot;本地文件地址&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferedInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>fileInputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FSDataOutputStream</span> outputStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>remoteFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copyBytes</span><span class="token punctuation">(</span>bufferedInputStream<span class="token punctuation">,</span> outputStream<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferedInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bufferedInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fileInputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="获取文件块信息"><a href="#获取文件块信息" class="header-anchor">#</a> 获取文件块信息</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getFileBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token class-name">Path</span> remoteFilePath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;hdfs文件路径&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FileStatus</span> fileStatus <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">getFileStatus</span><span class="token punctuation">(</span>remoteFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BlockLocation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> blockLocations <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">getFileBlockLocations</span><span class="token punctuation">(</span>fileStatus<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fileStatus<span class="token punctuation">.</span><span class="token function">getLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BlockLocation</span> blockLocation <span class="token operator">:</span> blockLocations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>blockLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="mapreduce"><a href="#mapreduce" class="header-anchor">#</a> MapReduce</h2> <h3 id="map映射"><a href="#map映射" class="header-anchor">#</a> Map映射</h3> <p><img src="/images/map%E6%98%A0%E5%B0%84.png" alt="map映射"></p> <blockquote><p>以上三种操作，在进行计算时，是以一条记录为单位，不会关心其他记录的，这种转换的过程就叫做映射 Map</p> <ol><li>过滤</li> <li>转换</li> <li>一变多</li></ol></blockquote> <h3 id="reduce分组计算"><a href="#reduce分组计算" class="header-anchor">#</a> Reduce分组计算</h3> <p><img src="/images/Reduce%E5%88%86%E7%BB%84%E8%AE%A1%E7%AE%97.png" alt="Reduce分组计算"></p> <blockquote><p>以一组为单位的计算时，叫做分组，分组必须要有一个key值，也就是kv的实现。</p></blockquote> <h3 id="mapreduce-2"><a href="#mapreduce-2" class="header-anchor">#</a> MapReduce</h3> <ol><li>Map
<ul><li>映射、变换、过滤</li> <li>1进N出</li></ul></li> <li>Reduce
<ul><li>分解、缩小、归纳</li> <li>一组进N出</li></ul></li> <li>(KEY,VAL)
<ul><li>键值对的键划分数据分组</li></ul></li></ol> <p><img src="/images/MapReduce.png" alt="MapReduce"></p> <h3 id="mapreduce详细的计算过程"><a href="#mapreduce详细的计算过程" class="header-anchor">#</a> MapReduce详细的计算过程</h3> <p><img src="/images/MapReduce%E8%AF%A6%E7%BB%86%E7%9A%84%E8%AE%A1%E7%AE%97%E8%BF%87%E7%A8%8B.png" alt="MapReduce详细的计算过程"></p> <blockquote><p>数据以一条记录为单位经过Map方法映射成KV，相同的key为一组，这一组数据调用一次Reduce方法，在方法内迭代计算这一组的数据。</p></blockquote> <ol><li><p>一个 split（切片）对应一个Map任务</p></li> <li><p>一个文件在HDFS中会根据blockSize切成N多个块</p></li> <li><p>默认情况下，一个 split（切片）对应一个block块</p> <p><strong>加入 split（切片）的概念是为了和block块解耦，可以支持动态调整切片大小</strong></p></li> <li><p>所有的Map执行完成之后，才能进行Reduce环节执行（线性依赖关系）</p></li> <li><p>有几个Reduce，就可以按照key的hash模上几，拉取到不同的Reduce进程里（Reduce中组是不能再分的）</p></li> <li><p>Map的并行度有split（切片）来决定，Reduce的并行度（默认一个）有人来决定</p></li> <li><p>一个Reduce执行的任务交一个分区</p></li></ol> <p><strong>比例关系：</strong></p> <ol><li>block &gt; split
<ul><li>1:1（默认）</li> <li>N:1</li> <li>1:N（CPU密集型）</li></ul></li> <li>split &gt; map
<ul><li>1:1</li></ul></li> <li>map &gt; reduce
<ul><li>N:1（默认）</li> <li>N:N（人为指定多个Reduce，同一个组不能被打散到不同的 partition（分区，task任务，一个Reduce任务）里）</li> <li>1:1</li> <li>1:N（人为指定map为1个，多个reduce处理不同的组）</li></ul></li> <li>group(key) &gt; partition
<ul><li>1:1（一个组去到一个partition）</li> <li>N:1（一个partition（task任务，Reduce任务）处理所有的组）</li> <li>N:N</li></ul></li></ol> <h3 id="mapreduce详细拆解过程"><a href="#mapreduce详细拆解过程" class="header-anchor">#</a> MapReduce详细拆解过程</h3> <blockquote><p><font color="red"><strong>迭代器模式是批量计算中非常优美的实现形！！！</strong></font></p></blockquote> <p><img src="/images/MapReduce%E8%AF%A6%E7%BB%86%E6%8B%86%E8%A7%A3%E8%BF%87%E7%A8%8B.png" alt="MapReduce详细拆解过程"></p> <ol><li>切片会格式化出记录，以记录为单位调用map方法</li> <li>map的输出映射成KV，kv会参与分区计算，拿着key算出P，分区号，K,V,P</li> <li>内存缓冲区溢写磁盘时：<font color="red"><strong>做一个2次排序：分区有序，且分区内key有序</strong></font>；未来相同的一组key会相邻的排在一起
<ul><li>如果此时不做排序，当执行Reduce时，每一个Reduce都要全量遍历该文件，增大磁盘IO</li> <li>当内存缓存区溢写磁盘时，进行一次排序（内存比磁盘快了10万倍，在内存中排序不影响性能，缓冲区有大小限制，不会特别大）</li></ul></li> <li>reduce的归并排序其实可以和reduce方法的计算同时发生，尽量减少IO。因为有迭代器模式的支持！！！</li></ol> <h2 id="计算向数据移动"><a href="#计算向数据移动" class="header-anchor">#</a> 计算向数据移动</h2> <blockquote><p>HDFS肯定会暴露block块的位置</p> <ol><li>DataNode负责管理Block</li> <li>TaskTracker一般会和DataNode部署在一起，主要负责任务的执行</li></ol> <p>最终计算向数据移动的实现：<strong>代码在某一个节点被启动，通过cli上传，TaskTracker下载，并启动相应的任务</strong></p></blockquote> <p><img src="/images/%E8%AE%A1%E7%AE%97%E5%A6%82%E4%BD%95%E5%90%91%E6%95%B0%E6%8D%AE%E7%A7%BB%E5%8A%A8.png" alt="JobTracker"></p> <h3 id="client"><a href="#client" class="header-anchor">#</a> Client</h3> <ol><li>有执行逻辑（MR）</li> <li>会根据每次的计算数据，咨询NameNode获取元数据的Block信息（offset，locations），并计算split（切片），最终得到一个切片的清单（包含：split的偏移量，以及对应的map任务应该移动到哪些节点 locations ）</li> <li>生成计算程序未来运行时的相关配置文件</li> <li>未来的移动应该相对可靠：<strong>client会将jar，split清单，配置文件，上传到HDFS的目录中，此时的副本默认数是10</strong></li> <li>调用JobTracker，通知要启动一个计算程序了，并且告诉文件放在了HDFS的哪些地方</li></ol> <h3 id="jobtracker"><a href="#jobtracker" class="header-anchor">#</a> JobTracker</h3> <p><strong>作用</strong></p> <ol><li>资源管理</li> <li>任务调度</li></ol> <p><strong>存在的问题</strong></p> <ol><li><p>单点故障</p></li> <li><p>压力过大</p></li> <li><p>集成了资源管理和任务调度，两者耦合</p> <p><strong>未来新的计算框架不能复用资源管理</strong></p> <ul><li>重复造轮子</li> <li>因为各自实现资源管理，但是他们不熟在同一批硬件上，因为隔离，所以不能感知对方的使用，会造成资源争抢</li></ul></li></ol> <p><strong>执行流程：</strong></p> <ol><li>从HDFS中取回split清单</li> <li>根据自己收到的TaskTracker汇报的资源，最终确定每一个split对应的map应该去到哪一个节点，得到一个确定的清单</li> <li>未来TaskTracker在做心跳的时候，会取回分配给自己的任务信息</li></ol> <h3 id="tasktracker"><a href="#tasktracker" class="header-anchor">#</a> TaskTracker</h3> <ol><li>任务管理</li> <li>资源汇报</li></ol> <p><strong>执行流程：</strong></p> <ol><li>在心跳取回任务信息</li> <li>从HDFS中下载jar和相关配置文件到本地</li> <li>最终启动任务描述中的Map/Reduce</li></ol> <h2 id="yarn：资源管理"><a href="#yarn：资源管理" class="header-anchor">#</a> Yarn：资源管理</h2> <h3 id="架构图"><a href="#架构图" class="header-anchor">#</a> 架构图</h3> <blockquote><ol><li>MR-cli （切片清单 / 配置 / jar / 上传到HDFS）</li> <li>访问RM申请AppMaster</li> <li>RM选择一台不忙的节点通知NM启动一个Container，在里面反射生成一个MRAppMaster</li> <li>启动MRAppMaster，从HDFS上下载切片清单，向RM申请资源</li> <li>RM根据自己掌握的资源情况得到一个确定的清单，通知NM来启动container</li> <li>container启动后会反向注册到已经启动的MRAppMaster进程</li> <li>MRAppMaster（更像曾经的JobTracker阉割版(不带资源管理)）最终会将任务Task发送给container（消息）</li> <li>container会反射相应的Task类为对象，调用方法执行，其结果就是执行我们的业务逻辑代码</li> <li>计算框架都有Task失败重试的机制。</li></ol></blockquote> <p><img src="/images/yarn%E6%9E%B6%E6%9E%84-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86.gif" alt="yarn架构-资源管理"></p> <blockquote><p><strong>结论：</strong></p> <ol><li>单点故障
<ul><li>曾经是全局的，JobTracker如果挂了，整个计算层没有了调度</li> <li>yarn：每一个app都有一个自己的AppMaster调度，AppMaster支持失败重试</li></ul></li> <li>压力过大
<ul><li>yarn中每个计算程序自由AppMaster，每个AppMaster只负责自己计算程序的任务调度，AppMaster是在不同的节点中启动的，默认有了负载的光环</li></ul></li> <li>集成了资源管理和任务调度，两者耦合
<ul><li>因为yarn只是资源管理，不负责具体的任务调度；只要计算框架继承了yarn的AppMaster，大家都可以使用一个统一视图的资源层。</li></ul></li></ol></blockquote> <h3 id="模型"><a href="#模型" class="header-anchor">#</a> 模型</h3> <h4 id="resourcemanager"><a href="#resourcemanager" class="header-anchor">#</a> ResourceManager</h4> <blockquote><p>ResourceManager支持HA模式</p></blockquote> <p><strong>作用：</strong></p> <ol><li>与客户端进行交互，处理来自于客户端的请求，如查询应用的运行情况等。</li> <li>启动和管理各个应用的ApplicationMaster，并且为ApplicationMaster申请第一个Container用于启动和在它运行失败时将它重新启动。</li> <li>管理NodeManager，接收来自NodeManager的资源和节点健康情况汇报，并向NodeManager下达管理资源命令，例如kill掉某个container。</li> <li>资源管理和调度，接收来自ApplicationMaster的资源申请，并且为其进行分配。这个是它的最重要的职能。</li></ol> <h4 id="nodemanager"><a href="#nodemanager" class="header-anchor">#</a> NodeManager</h4> <p><strong>作用：</strong></p> <ol><li>NodeManager通过<strong>ResourceTrackerProtocol</strong>协议向RM注册，汇报节点的健康状态以及Container的运行状态，并领取RM下发的命令例如重新初始化Container，清理Container等；在这个协议中NodeManager主动向RM发请求，RM响应NodeManager的请求。</li> <li>应用程序的ApplicationMaster通过<strong>ContainerManagementProtocol</strong>协议与NodeManager通信发起针对Container的命令操作，例如：启动，杀死Container，获取Container的运行状态等；在该协议中ApplicationMaster主动向NodeManager发送请求，NodeManager接收到请求做出响应。</li></ol> <h4 id="applicationmaster"><a href="#applicationmaster" class="header-anchor">#</a> ApplicationMaster</h4> <blockquote><p>ApplicationMaster实际上是特定计算框架的一个实例，每种计算框架都有自己独特的ApplicationMaster，负责与ResourceManager协商资源，并和NodeManager协同来执行和监控Container。MapReduce只是可以运行在YARN上一种计算框架。</p></blockquote> <p><strong>作用：</strong></p> <ol><li>初始化向ResourceManager报告自己的活跃信息的进程</li> <li>计算应用程序的的资源需求。
<ul><li>静态资源：在任务提交时就能确定，并且在AM运行时不再变化的资源，比如MapReduce程序中的Map的数量</li> <li>动态资源： AM在运行时确定要请求数量的资源是动态资源。</li></ul></li> <li>将需求转换为YARN调度器可以理解的ResourceRequest，与调度器协商申请资源</li> <li>与NodeManager协同合作使用分配的Container</li> <li>跟踪正在运行的Container状态，监控它的运行。</li> <li>对Container或者节点失败的情况进行处理，在必要的情况下重新申请资源。</li></ol> <h4 id="container"><a href="#container" class="header-anchor">#</a> container</h4> <blockquote><p>可以让JVM进程在上面运行；被NodeManager监控资源使用情况，如果发现有超额，NodeManager直接把该进程 kill 掉；使用 cgroup 内核级技术，在启动JVM进程时，由Kernel 约束死使用的资源。</p></blockquote> <ol><li>是集群中单个节点上的一组资源（内存，CPU，归属于哪个NM），由NM监控，由RM调度</li> <li>接收ApplicationMaster的任务启动命令</li> <li>主动拉取HDFS上的jar和相关的配置，作为任务运行环境</li></ol> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <ol><li>1.x 中 JobTracker、TaskTracker是常服务。</li> <li>2.x 只有没有了这些服务；相对的，MR的cli、【调度】、【任务】，这些都是临时的服务了。</li></ol> <h2 id="client源码分析"><a href="#client源码分析" class="header-anchor">#</a> Client源码分析</h2> <blockquote><div class="language- extra-class"><pre class="language-text"><code>没有计算发生
很重要：支撑了计算向数据移动和计算的并行度
1，Checking the input and output specifications of the job.
2，Computing the InputSplits for the job.  // split  -&gt;并行度和计算向数据移动就可以实现了
3，Setup the requisite accounting information for the DistributedCache of the job, if necessary.
4，Copying the job's jar and configuration to the map-reduce system directory on the distributed file-system.
5，Submitting the job to the JobTracker and optionally monitoring it's status
MR框架默认的输入格式化类： TextInputFormat &lt; FileInputFormat &lt; InputFormat
                  						getSplits()
   minSize = 1
   maxSize = Long.Max
   blockSize = file
   splitSize = Math.max(minSize, Math.min(maxSize, blockSize));  //默认split大小等于block大小
      切片split是一个窗口机制：（调大split改小，调小split改大）
         如果我想得到一个比block大的split：
   if ((blkLocations[i].getOffset() &lt;= offset &lt; blkLocations[i].getOffset() + blkLocations[i].getLength()))
   split：解耦 存储层和计算层
      1，file
      2，offset
      3，length
      4，hosts    //支撑的计算向数据移动
</code></pre></div></blockquote> <p><img src="/images/split%E5%88%87%E7%89%87%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B.png" alt="split切片主要流程"></p> <h3 id="默认输入格式化类"><a href="#默认输入格式化类" class="header-anchor">#</a> 默认输入格式化类</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 输入格式化类，默认为TextInputFormat.class</span>
<span class="token comment">// 可以通过以下几种方式进行干预</span>
<span class="token comment">// 1. job.setInputFormatClass(TextInputFormat.class);</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">InputFormat</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> 
      conf<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span>INPUT_FORMAT_CLASS_ATTR<span class="token punctuation">,</span> <span class="token class-name">TextInputFormat</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="计算切片"><a href="#计算切片" class="header-anchor">#</a> 计算切片</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/** 
  * Generate the list of files and make them into FileSplits.
  * @param job the job context
  * @throws IOException
  */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> <span class="token function">getSplits</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span> job<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">StopWatch</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认值：1，</span>
    <span class="token comment">// 可以通过以下几种方式进行干预</span>
    <span class="token comment">// 1. TextInputFormat.setMinInputSplitSize(job, 111);</span>
    <span class="token comment">// 2. conf.set(FileInputFormat.SPLIT_MINSIZE, &quot;111&quot;);</span>
    <span class="token comment">// 3. 也可以通过运行主方法时外部传参</span>
    <span class="token keyword">long</span> minSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">getFormatMinSplitSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getMinSplitSize</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 默认值：Long.MAX_VALUE</span>
    <span class="token comment">// 可以通过以下几种方式进行干预</span>
    <span class="token comment">// 1. TextInputFormat.setMaxInputSplitSize(job, 111);</span>
    <span class="token comment">// 2. conf.set(FileInputFormat.SPLIT_MAXSIZE, &quot;111&quot;);</span>
    <span class="token comment">// 3. 也可以通过运行主方法时外部传参</span>
    <span class="token keyword">long</span> maxSize <span class="token operator">=</span> <span class="token function">getMaxSplitSize</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// generate splits</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> splits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取当前job计算需要的所有文件的状态列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FileStatus</span><span class="token punctuation">&gt;</span></span> files <span class="token operator">=</span> <span class="token function">listStatus</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FileStatus</span> file<span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Path</span> path <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> length <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 每一个文件所有的block块信息</span>
            <span class="token class-name">BlockLocation</span><span class="token punctuation">[</span><span class="token punctuation">]</span> blkLocations<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token keyword">instanceof</span> <span class="token class-name">LocatedFileStatus</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                blkLocations <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LocatedFileStatus</span><span class="token punctuation">)</span> file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBlockLocations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                blkLocations <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">getFileBlockLocations</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 是否可以做切片，分布式文件可以做切片</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSplitable</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 块文件大小</span>
                <span class="token keyword">long</span> blockSize <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getBlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 计算切片大小：splitSize = Math.max(minSize, Math.min(maxSize, blockSize));</span>
                <span class="token comment">// minSize默认是1，maxSize默认事Long.MAX_VALUE</span>
                <span class="token comment">// block只要有内容，blockSize肯定大于1，故默认 splitSize = blockSize</span>
                <span class="token comment">// 切片 split 是一个窗口机制（调大split改小值，调小split改大值）</span>
                <span class="token comment">// 如果我想得到一个比block大的split,</span>
                <span class="token comment">// 人为干预 minSize 的大小，只要比 blockSize 大即可</span>
                <span class="token comment">// 如果我想得到一个比block小的split,</span>
                <span class="token comment">// 人为干预 maxSize 的大小，只要比 blockSize 小即可</span>
                <span class="token keyword">long</span> splitSize <span class="token operator">=</span> <span class="token function">computeSplitSize</span><span class="token punctuation">(</span>blockSize<span class="token punctuation">,</span> minSize<span class="token punctuation">,</span> maxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token comment">// 找到每一个切片对应的块的偏移量的算法</span>
                <span class="token comment">// 切片最重要的四个属性：1.file;2.offset;3.length;4.hosts//支持计算向数据移动</span>
<span class="token comment">// blkLocations[i].getOffset() &lt;= offset &lt; blkLocations[i].getOffset() + blkLocations[i].getLength()</span>
                <span class="token keyword">long</span> bytesRemaining <span class="token operator">=</span> length<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> bytesRemaining<span class="token punctuation">)</span><span class="token operator">/</span>splitSize <span class="token operator">&gt;</span> SPLIT_SLOP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> blkIndex <span class="token operator">=</span> <span class="token function">getBlockIndex</span><span class="token punctuation">(</span>blkLocations<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">,</span> splitSize<span class="token punctuation">,</span>
                                         blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                         blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bytesRemaining <span class="token operator">-=</span> splitSize<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 处理最后一个block块</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRemaining <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> blkIndex <span class="token operator">=</span> <span class="token function">getBlockIndex</span><span class="token punctuation">(</span>blkLocations<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> length<span class="token operator">-</span>bytesRemaining<span class="token punctuation">,</span> bytesRemaining<span class="token punctuation">,</span>
                                         blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                         blkLocations<span class="token punctuation">[</span>blkIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
<span class="token comment">// 经过上面的算法实例demo</span>
<span class="token comment">// 文件大小：100</span>
<span class="token comment">// 块大小：　10</span>
<span class="token comment">// 切片大小：15</span>
<span class="token comment">// offset,splitSize,	blockIndex</span>
<span class="token comment">// 0,15					0</span>
<span class="token comment">// 15,15				1</span>
<span class="token comment">// 30,15				3</span>
<span class="token comment">// 45,15				4</span>
<span class="token comment">// 60,15				6</span>
<span class="token comment">// 75,15				7</span>
<span class="token comment">// 90,10,				9</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// not splitable</span>
                splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> blkLocations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     blkLocations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getCachedHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
            <span class="token comment">//Create empty hosts array for zero length files</span>
            splits<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">makeSplit</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Save the number of input files for metrics/loadgen</span>
    job<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span>NUM_INPUT_FILES<span class="token punctuation">,</span> files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sw<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>LOG<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Total # of splits generated by getSplits: &quot;</span> <span class="token operator">+</span> splits<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token operator">+</span> <span class="token string">&quot;, TimeTaken: &quot;</span> <span class="token operator">+</span> sw<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> splits<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="上传切片清单和配置"><a href="#上传切片清单和配置" class="header-anchor">#</a> 上传切片清单和配置</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InputSplit</span><span class="token punctuation">&gt;</span></span> splits <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getSplits</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> splits<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputSplit</span><span class="token punctuation">[</span>splits<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// sort the splits into order based on size, so that the biggest</span>
<span class="token comment">// go first</span>
<span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SplitComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 切片清单和配置写入hdfs</span>
<span class="token class-name">JobSplitWriter</span><span class="token punctuation">.</span><span class="token function">createSplitFiles</span><span class="token punctuation">(</span>jobSubmitDir<span class="token punctuation">,</span> conf<span class="token punctuation">,</span> 
                                jobSubmitDir<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="maptask源码分析"><a href="#maptask源码分析" class="header-anchor">#</a> MapTask源码分析</h2> <blockquote><div class="language- extra-class"><pre class="language-text"><code>input -&gt;  map  -&gt; output
input:(split+format)  通用的知识，未来的spark底层也是
	来自于我们的输入格式化类给我们实际返回的记录读取器对象
		TextInputFormat-&gt;LineRecordreader
			split: file , offset , length
			init():
				in = fs.open(file).seek(offset)
				除了第一个切片对应的map，之后的map都在init环节，
				从切片包含的数据中，让出第一行，并把切片的起始更新为切片的第二行。
				换言之，前一个map会多读取一行，来弥补hdfs把数据切割的问题~！
			nextKeyValue():
				1，读取数据中的一条记录对key，value赋值
				2，返回布尔值
			getCurrentKey():
			getCurrentValue():

output：
NewOutputCollector
	partitioner
	collector
		MapOutputBuffer:
		*：
		map输出的KV会序列化成字节数组，算出P，最中是3元组：K,V,P
		buffer是使用的环形缓冲区：
		1，本质还是线性字节数组
		2，赤道，两端方向放KV,索引
		3，索引：是固定宽度：16B：4个int
			a)Partition		分区号
			b)Key Start		key的起始位置
			c)Value Start	value的起始位置
			d)Value Length	value的长度
		5,如果数据填充到阈值：80%，启动线程：
			快速排序80%数据，同时map输出的线程向剩余的空间写
			快速排序的过程：是比较key排序，但是移动的是索引
		6，最终，溢写时只要按照排序的索引，卸下的文件中的数据就是有序的
			注意：排序是二次排序（索引里有P，排序先比较索引的P决定顺序，然后在比较相同P中的Key的顺序）
				分区有序  ： 最后reduce拉取是按照分区的
				分区内key有序： 因为reduce计算是按分组计算，分组的语义（相同的key排在了一起）
		7，调优：combiner
			1，其实就是一个map里的reduce
				按组统计
			2，发生在哪个时间点：
				a)内存溢写数据之前排序之后
					溢写的io变少~！
				b)最终map输出结束，过程中，buffer溢写出多个小文件（内部有序）
					minSpillsForCombine = 3（当溢写次数超过了这个值，会触发合并的combiner）
					map最终会把溢写出来的小文件合并成一个大文件：
						避免小文件的碎片化对未来reduce拉取数据造成的随机读写
					也会触发combine
			3，combine注意
				必须幂等
				例子：
					1，求和计算
					1，平均数计算
						80：数值和，个数和
		init():
			spillper = 0.8
			sortmb = 100M
			sorter = QuickSort
			comparator = job.getOutputKeyComparator();
				1，优先取用户覆盖的自定义排序比较器
				2，保底，取key这个类型自身的比较器
			combiner ？reduce
				minSpillsForCombine = 3

			SpillThread
				sortAndSpill()
					if (combinerRunner == null)
</code></pre></div></blockquote> <h3 id="map主要流程：maptask-run"><a href="#map主要流程：maptask-run" class="header-anchor">#</a> Map主要流程：MapTask.run();</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    input<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>split<span class="token punctuation">,</span> mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用map的run方法</span>
    mapper<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算完成</span>
    mapPhase<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行排序</span>
    <span class="token function">setPhase</span><span class="token punctuation">(</span><span class="token class-name">TaskStatus</span><span class="token punctuation">.</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>SORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 状态更新</span>
    <span class="token function">statusUpdate</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭输入流</span>
    input<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    input <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 关闭输出流</span>
    output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    output <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">closeQuietly</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> mapperContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="前置参数组装：maptask-runnewmapper"><a href="#前置参数组装：maptask-runnewmapper" class="header-anchor">#</a> 前置参数组装：MapTask.runNewMapper();</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// make a task context so we can get the classes</span>
<span class="token comment">// 构造一个任务的上下文对象，方便在后续的处理逻辑中拿到相关的配置</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">TaskAttemptContext</span> taskContext <span class="token operator">=</span>
    <span class="token keyword">new</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token class-name">TaskAttemptContextImpl</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> 
                                                                <span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// make a mapper</span>
<span class="token comment">// 根据指定的 MapperClass 类反射出对象</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">,</span>OUTKEY<span class="token punctuation">,</span>OUTVALUE<span class="token punctuation">&gt;</span></span> mapper <span class="token operator">=</span>
    <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">,</span>OUTKEY<span class="token punctuation">,</span>OUTVALUE<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">.</span><span class="token function">getMapperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// make the input format</span>
<span class="token comment">// 根据指定的或者默认的输入格式化类，反射出具体的输入对象</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">InputFormat</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">&gt;</span></span> inputFormat <span class="token operator">=</span>
    <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">InputFormat</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
    <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">.</span><span class="token function">getInputFormatClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// rebuild the input split</span>
<span class="token comment">// 根据当前map获取要读取文件块的切片（此时计算已经移动到对应的节点上了）</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">InputSplit</span> split <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
split <span class="token operator">=</span> <span class="token function">getSplitDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>splitIndex<span class="token punctuation">.</span><span class="token function">getSplitLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        splitIndex<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Processing split: &quot;</span> <span class="token operator">+</span> split<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 构造一个记录读取器：把切片和输入格式化类传了进去，就意味着，这个类可以读取指定偏移位置的数据了</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">RecordReader</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">&gt;</span></span> input <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">NewTrackingRecordReader</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">(</span>split<span class="token punctuation">,</span> inputFormat<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> taskContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

job<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>SKIP_RECORDS<span class="token punctuation">,</span> <span class="token function">isSkipping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">RecordWriter</span> output <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token comment">// get an output object</span>
<span class="token comment">// 构造输出格式化类</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getNumReduceTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    output <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">NewDirectOutputCollector</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">,</span> job<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 引用！！！Map输出的处理：创建分区器！！！</span>
    output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NewOutputCollector</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">,</span> job<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 包装 MapContext 的上下文对象</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">MapContext</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span> INVALUE<span class="token punctuation">,</span> OUTKEY<span class="token punctuation">,</span> OUTVALUE<span class="token punctuation">&gt;</span></span> 
    mapContext <span class="token operator">=</span> 
    <span class="token keyword">new</span> <span class="token class-name">MapContextImpl</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span> INVALUE<span class="token punctuation">,</span> OUTKEY<span class="token punctuation">,</span> OUTVALUE<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                                         input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> 
                                                         committer<span class="token punctuation">,</span> 
                                                         reporter<span class="token punctuation">,</span> split<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 再包装 Mapper 的上下文对象</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">,</span>OUTKEY<span class="token punctuation">,</span>OUTVALUE<span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token class-name">Context</span> 
    mapperContext <span class="token operator">=</span> 
    <span class="token keyword">new</span> <span class="token class-name">WrappedMapper</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span> INVALUE<span class="token punctuation">,</span> OUTKEY<span class="token punctuation">,</span> OUTVALUE<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMapContext</span><span class="token punctuation">(</span>
    mapContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="map的run方法"><a href="#map的run方法" class="header-anchor">#</a> Map的run方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
  * Expert users can override this method for more complete control over the
  * execution of the Mapper.
  * @param context
  * @throws IOException
  */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token function">setup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这个context里面包装了很多层对象，最重要的是包装了 记录读取器以及切片</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">nextKeyValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">map</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">cleanup</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="recordreader初始化对于切割字符串的处理"><a href="#recordreader初始化对于切割字符串的处理" class="header-anchor">#</a> RecordReader初始化对于切割字符串的处理</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">InputSplit</span> genericSplit<span class="token punctuation">,</span>
                       <span class="token class-name">TaskAttemptContext</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先拿到切片</span>
    <span class="token class-name">FileSplit</span> split <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">FileSplit</span><span class="token punctuation">)</span> genericSplit<span class="token punctuation">;</span>
    <span class="token class-name">Configuration</span> job <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maxLineLength <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>MAX_LINE_LENGTH<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 拿到切片的起始位置（也就是offset）</span>
    start <span class="token operator">=</span> split<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 计算切片的终止位置</span>
    end <span class="token operator">=</span> start <span class="token operator">+</span> split<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Path</span> file <span class="token operator">=</span> split<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// open the file and seek to the start of the split（打开文件系统，并seek到切片的起始位置）</span>
    <span class="token comment">// 拿到分布式文件系统的文件对象</span>
    <span class="token keyword">final</span> <span class="token class-name">FileSystem</span> fs <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打开要读取的文件（面向文件的输入流）</span>
    fileIn <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">CompressionCodec</span> codec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompressionCodecFactory</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCodec</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token operator">!=</span>codec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isCompressedInput <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        decompressor <span class="token operator">=</span> <span class="token class-name">CodecPool</span><span class="token punctuation">.</span><span class="token function">getDecompressor</span><span class="token punctuation">(</span>codec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>codec <span class="token keyword">instanceof</span> <span class="token class-name">SplittableCompressionCodec</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">SplitCompressionInputStream</span> cIn <span class="token operator">=</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SplittableCompressionCodec</span><span class="token punctuation">)</span>codec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createInputStream</span><span class="token punctuation">(</span>
                fileIn<span class="token punctuation">,</span> decompressor<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span>
                <span class="token class-name">SplittableCompressionCodec</span><span class="token punctuation">.</span>READ_MODE<span class="token punctuation">.</span>BYBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompressedSplitLineReader</span><span class="token punctuation">(</span>cIn<span class="token punctuation">,</span> job<span class="token punctuation">,</span>
                                               <span class="token keyword">this</span><span class="token punctuation">.</span>recordDelimiterBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            start <span class="token operator">=</span> cIn<span class="token punctuation">.</span><span class="token function">getAdjustedStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            end <span class="token operator">=</span> cIn<span class="token punctuation">.</span><span class="token function">getAdjustedEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            filePosition <span class="token operator">=</span> cIn<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// So we have a split that is only part of a file stored using</span>
                <span class="token comment">// a Compression codec that cannot be split.</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot seek in &quot;</span> <span class="token operator">+</span>
                                      codec<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; compressed stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SplitLineReader</span><span class="token punctuation">(</span>codec<span class="token punctuation">.</span><span class="token function">createInputStream</span><span class="token punctuation">(</span>fileIn<span class="token punctuation">,</span>
                                                             decompressor<span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>recordDelimiterBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            filePosition <span class="token operator">=</span> fileIn<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// seek到自己要读的切片的起始位置</span>
        fileIn<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UncompressedSplitLineReader</span><span class="token punctuation">(</span>
            fileIn<span class="token punctuation">,</span> job<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>recordDelimiterBytes<span class="token punctuation">,</span> split<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filePosition <span class="token operator">=</span> fileIn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// If this is not the first split, we always throw away first record</span>
    <span class="token comment">// because we always (except the last split) read one extra line in</span>
    <span class="token comment">// next() method.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 非第一个block块，读取第一行数据丢弃，更改偏移量的起始（从第二行开始）</span>
        <span class="token comment">// 意味着每一个map都会读取下一个block块的第一行数据</span>
        <span class="token comment">// 或多或少都会有一部分数据移动的过程，但这个数据不是全量，只是一部分，总的来说要比单机快很多</span>
        start <span class="token operator">+=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">maxBytesToConsume</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> start<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="recordreader的nextkeyvalue方法"><a href="#recordreader的nextkeyvalue方法" class="header-anchor">#</a> RecordReader的nextKeyValue方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">nextKeyValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// map任务第一次进来，key为空，创建一个LongWritable对象，（）</span>
        key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LongWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 设置起始偏移量</span>
    key<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> newSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// We always read one extra line, which lies outside the upper</span>
    <span class="token comment">// split limit i.e. (end - 1)</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">getFilePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> end <span class="token operator">||</span> in<span class="token punctuation">.</span><span class="token function">needAdditionalRecordAfterSplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pos <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newSize <span class="token operator">=</span> <span class="token function">skipUtfByteOrderMark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读出一行，value的引用指向了行记录，</span>
            newSize <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> maxLineLength<span class="token punctuation">,</span> <span class="token function">maxBytesToConsume</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更改起始位置偏移量，因为这一行已经读过了</span>
            pos <span class="token operator">+=</span> newSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>newSize <span class="token operator">&lt;</span> maxLineLength<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// line too long. try again</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Skipped line of size &quot;</span> <span class="token operator">+</span> newSize <span class="token operator">+</span> <span class="token string">&quot; at pos &quot;</span> <span class="token operator">+</span> 
                 <span class="token punctuation">(</span>pos <span class="token operator">-</span> newSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 只要能够拿到行大小（newSize），就返回true，同时给key，value进行赋值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">LongWritable</span> <span class="token function">getCurrentKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Text</span> <span class="token function">getCurrentValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="map输出的处理：创建分区器"><a href="#map输出的处理：创建分区器" class="header-anchor">#</a> Map输出的处理：创建分区器</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">NewOutputCollector</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">JobContext</span> jobContext<span class="token punctuation">,</span>
                   <span class="token class-name">JobConf</span> job<span class="token punctuation">,</span>
                   <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">,</span>
                   <span class="token class-name">TaskReporter</span> reporter
                  <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构造 MapOutputBuffer 对象</span>
    <span class="token comment">// Class&lt;?&gt;[] collectorClasses = job.getClasses(</span>
  	<span class="token comment">// 			JobContext.MAP_OUTPUT_COLLECTOR_CLASS_ATTR, MapOutputBuffer.class);</span>
    collector <span class="token operator">=</span> <span class="token function">createSortingCollector</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 有多少个reduce任务，就有多少个分区</span>
    partitions <span class="token operator">=</span> jobContext<span class="token punctuation">.</span><span class="token function">getNumReduceTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>partitions <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建多分区的分区器，默认：Partitioner.class</span>
        <span class="token comment">// 可通过job.setPartitionerClass(clc.class);进行干预；</span>
        partitioner <span class="token operator">=</span> <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">Partitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
            <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>jobContext<span class="token punctuation">.</span><span class="token function">getPartitionerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建单分区的分区器为0</span>
        partitioner <span class="token operator">=</span> <span class="token keyword">new</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">Partitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPartition</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> partitions <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取分区器对象</span>
<span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Partitioner</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPartitionerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认分区器：HashPartitioner</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Partitioner</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> 
        conf<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span>PARTITIONER_CLASS_ATTR<span class="token punctuation">,</span> <span class="token class-name">HashPartitioner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashPartitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Partitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/** Use {@link Object#hashCode()} to partition. */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPartition</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span>
                            <span class="token keyword">int</span> numReduceTasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// HashPartitioner分区器：</span>
        <span class="token comment">// 计算分区个数：key.hashCode() &amp; Integer.MAX_VALUE得到一个非负的整数 模上 reduce 任务的个数</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token operator">%</span> numReduceTasks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="map输出的缓冲区初始化：mapoutputbuffer-init"><a href="#map输出的缓冲区初始化：mapoutputbuffer-init" class="header-anchor">#</a> Map输出的缓冲区初始化：MapOutputBuffer.init</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">MapOutputCollector</span><span class="token punctuation">.</span><span class="token class-name">Context</span> context
				<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
  job <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getJobConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  reporter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mapTask <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getMapTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  mapOutputFile <span class="token operator">=</span> mapTask<span class="token punctuation">.</span><span class="token function">getMapOutputFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sortPhase <span class="token operator">=</span> mapTask<span class="token punctuation">.</span><span class="token function">getSortPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  spilledRecordsCounter <span class="token operator">=</span> reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span>SPILLED_RECORDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  partitions <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getNumReduceTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rfs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LocalFileSystem</span><span class="token punctuation">)</span><span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">getLocal</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//sanity checks</span>
  <span class="token comment">// 溢写的阈值，默认0.8</span>
  <span class="token keyword">final</span> <span class="token keyword">float</span> spillper <span class="token operator">=</span>
	job<span class="token punctuation">.</span><span class="token function">getFloat</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>MAP_SORT_SPILL_PERCENT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 缓冲区总大小，默认100M</span>
  <span class="token keyword">final</span> <span class="token keyword">int</span> sortmb <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>IO_SORT_MB<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  indexCacheMemoryLimit <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>INDEX_CACHE_MEMORY_LIMIT<span class="token punctuation">,</span>
									 INDEX_CACHE_MEMORY_LIMIT_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>spillper <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">1.0</span> <span class="token operator">||</span> spillper <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid \&quot;&quot;</span> <span class="token operator">+</span> <span class="token class-name">JobContext</span><span class="token punctuation">.</span>MAP_SORT_SPILL_PERCENT <span class="token operator">+</span>
		<span class="token string">&quot;\&quot;: &quot;</span> <span class="token operator">+</span> spillper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sortmb <span class="token operator">&amp;</span> <span class="token number">0x7FF</span><span class="token punctuation">)</span> <span class="token operator">!=</span> sortmb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>
		<span class="token string">&quot;Invalid \&quot;&quot;</span> <span class="token operator">+</span> <span class="token class-name">JobContext</span><span class="token punctuation">.</span>IO_SORT_MB <span class="token operator">+</span> <span class="token string">&quot;\&quot;: &quot;</span> <span class="token operator">+</span> sortmb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 排序器，默认快排：QuickSort.class</span>
  sorter <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;map.sort.class&quot;</span><span class="token punctuation">,</span>
		<span class="token class-name">QuickSort</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">IndexedSorter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// buffers and accounting</span>
  <span class="token keyword">int</span> maxMemUsage <span class="token operator">=</span> sortmb <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>
  maxMemUsage <span class="token operator">-=</span> maxMemUsage <span class="token operator">%</span> METASIZE<span class="token punctuation">;</span>
  kvbuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>maxMemUsage<span class="token punctuation">]</span><span class="token punctuation">;</span>
  bufvoid <span class="token operator">=</span> kvbuffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  kvmeta <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>kvbuffer<span class="token punctuation">)</span>
	 <span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">ByteOrder</span><span class="token punctuation">.</span><span class="token function">nativeOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	 <span class="token punctuation">.</span><span class="token function">asIntBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setEquator</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufstart <span class="token operator">=</span> bufend <span class="token operator">=</span> bufindex <span class="token operator">=</span> equator<span class="token punctuation">;</span>
  kvstart <span class="token operator">=</span> kvend <span class="token operator">=</span> kvindex<span class="token punctuation">;</span>

  maxRec <span class="token operator">=</span> kvmeta<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> NMETA<span class="token punctuation">;</span>
  softLimit <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>kvbuffer<span class="token punctuation">.</span>length <span class="token operator">*</span> spillper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufferRemaining <span class="token operator">=</span> softLimit<span class="token punctuation">;</span>
  LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>IO_SORT_MB <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> sortmb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;soft limit at &quot;</span> <span class="token operator">+</span> softLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;bufstart = &quot;</span> <span class="token operator">+</span> bufstart <span class="token operator">+</span> <span class="token string">&quot;; bufvoid = &quot;</span> <span class="token operator">+</span> bufvoid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;kvstart = &quot;</span> <span class="token operator">+</span> kvstart <span class="token operator">+</span> <span class="token string">&quot;; length = &quot;</span> <span class="token operator">+</span> maxRec<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// k/v serialization</span>
  <span class="token comment">// 获取比较器，默认：Map输出的Key类型自身的比较器</span>
  comparator <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getOutputKeyComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取map输出的key的类型</span>
  keyClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>job<span class="token punctuation">.</span><span class="token function">getMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取map输出的value的类型</span>
  valClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>job<span class="token punctuation">.</span><span class="token function">getMapOutputValueClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 序列化key、value进行输出</span>
  serializationFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SerializationFactory</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  keySerializer <span class="token operator">=</span> serializationFactory<span class="token punctuation">.</span><span class="token function">getSerializer</span><span class="token punctuation">(</span>keyClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
  keySerializer<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  valSerializer <span class="token operator">=</span> serializationFactory<span class="token punctuation">.</span><span class="token function">getSerializer</span><span class="token punctuation">(</span>valClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
  valSerializer<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// output counters</span>
  mapOutputByteCounter <span class="token operator">=</span> reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span>MAP_OUTPUT_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mapOutputRecordCounter <span class="token operator">=</span>
	reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span>MAP_OUTPUT_RECORDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fileOutputByteCounter <span class="token operator">=</span> reporter
	  <span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span>MAP_OUTPUT_MATERIALIZED_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// compression</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>job<span class="token punctuation">.</span><span class="token function">getCompressMapOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">CompressionCodec</span><span class="token punctuation">&gt;</span></span> codecClass <span class="token operator">=</span>
	  job<span class="token punctuation">.</span><span class="token function">getMapOutputCompressorClass</span><span class="token punctuation">(</span><span class="token class-name">DefaultCodec</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	codec <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>codecClass<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	codec <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// combiner 优化器（也是一个比例问题（优化前和优化后的记录条数比），达到一定的比例，才会进行优化）</span>
  <span class="token comment">// 对map进行自身数据的reduce处理，可以减少io传输</span>
  <span class="token keyword">final</span> <span class="token class-name">Counters</span><span class="token punctuation">.</span><span class="token class-name">Counter</span> combineInputCounter <span class="token operator">=</span>
	reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span>COMBINE_INPUT_RECORDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  combinerRunner <span class="token operator">=</span> <span class="token class-name">CombinerRunner</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
										 combineInputCounter<span class="token punctuation">,</span>
										 reporter<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>combinerRunner <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">final</span> <span class="token class-name">Counters</span><span class="token punctuation">.</span><span class="token class-name">Counter</span> combineOutputCounter <span class="token operator">=</span>
	  reporter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token class-name">TaskCounter</span><span class="token punctuation">.</span>COMBINE_OUTPUT_RECORDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	combineCollector<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CombineOutputCollector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>combineOutputCounter<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	combineCollector <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  spillInProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 把溢写的小文件合并成一个大文件，默认：3。当溢写次数超过了这个值，会触发合并的combinerRunner</span>
  minSpillsForCombine <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>MAP_COMBINE_MIN_SPILLS<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  spillThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  spillThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;SpillThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  spillLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 溢写线程（排序，combiner、溢写）（combiner是在溢写的线程中执行的）</span>
	spillThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>spillThreadRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  spillDone<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Spill thread failed to initialize&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
	spillLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sortSpillException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Spill thread failed to initialize&quot;</span><span class="token punctuation">,</span>
		sortSpillException<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="map输出的处理：spillthread溢写线程"><a href="#map输出的处理：spillthread溢写线程" class="header-anchor">#</a> Map输出的处理：SpillThread溢写线程</h3> <p><img src="/images/Map%E8%BE%93%E5%87%BA%E7%8E%AF%E5%BD%A2%E7%BC%93%E5%86%B2%E5%8C%BA%E5%8F%8A%E6%8E%92%E5%BA%8F.png" alt="Map输出环形缓冲区及排序"></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 溢写线程</span>
<span class="token keyword">protected</span> <span class="token keyword">class</span> <span class="token class-name">SpillThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        spillLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        spillThreadRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                spillDone<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>spillInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    spillReady<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    spillLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">sortAndSpill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sortSpillException <span class="token operator">=</span> t<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    spillLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bufend <span class="token operator">&lt;</span> bufstart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        bufvoid <span class="token operator">=</span> kvbuffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    kvstart <span class="token operator">=</span> kvend<span class="token punctuation">;</span>
                    bufstart <span class="token operator">=</span> bufend<span class="token punctuation">;</span>
                    spillInProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            spillLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            spillThreadRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 排序并溢写</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sortAndSpill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span>
<span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">//approximate the length of the output file to be the length of the</span>
    <span class="token comment">//buffer + header lengths for the partitions</span>
    <span class="token keyword">final</span> <span class="token keyword">long</span> size <span class="token operator">=</span> <span class="token function">distanceTo</span><span class="token punctuation">(</span>bufstart<span class="token punctuation">,</span> bufend<span class="token punctuation">,</span> bufvoid<span class="token punctuation">)</span> <span class="token operator">+</span>
        partitions <span class="token operator">*</span> APPROX_HEADER_LENGTH<span class="token punctuation">;</span>
    <span class="token class-name">FSDataOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// create spill file</span>
        <span class="token keyword">final</span> <span class="token class-name">SpillRecord</span> spillRec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpillRecord</span><span class="token punctuation">(</span>partitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Path</span> filename <span class="token operator">=</span>
            mapOutputFile<span class="token punctuation">.</span><span class="token function">getSpillFileForWrite</span><span class="token punctuation">(</span>numSpills<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out <span class="token operator">=</span> rfs<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> mstart <span class="token operator">=</span> kvend <span class="token operator">/</span> NMETA<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> mend <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token comment">// kvend is a valid record</span>
            <span class="token punctuation">(</span>kvstart <span class="token operator">&gt;=</span> kvend
             <span class="token operator">?</span> kvstart
             <span class="token operator">:</span> kvmeta<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> kvstart<span class="token punctuation">)</span> <span class="token operator">/</span> NMETA<span class="token punctuation">;</span>
        sorter<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">MapOutputBuffer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> mstart<span class="token punctuation">,</span> mend<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> spindex <span class="token operator">=</span> mstart<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">IndexRecord</span> rec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">InMemValBytes</span> value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InMemValBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> partitions<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">IFile</span><span class="token punctuation">.</span><span class="token class-name">Writer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> writer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> segmentStart <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">getPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">FSDataOutputStream</span> partitionOut <span class="token operator">=</span> <span class="token class-name">CryptoUtils</span><span class="token punctuation">.</span><span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
                writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Writer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> partitionOut<span class="token punctuation">,</span> keyClass<span class="token punctuation">,</span> valClass<span class="token punctuation">,</span> codec<span class="token punctuation">,</span>
                                          spilledRecordsCounter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 溢写过程中调用 combiner 优化器</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>combinerRunner <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// spill directly</span>
                    <span class="token class-name">DataInputBuffer</span> key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>spindex <span class="token operator">&lt;</span> mend <span class="token operator">&amp;&amp;</span>
                           kvmeta<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">offsetFor</span><span class="token punctuation">(</span>spindex <span class="token operator">%</span> maxRec<span class="token punctuation">)</span> <span class="token operator">+</span> PARTITION<span class="token punctuation">)</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token keyword">int</span> kvoff <span class="token operator">=</span> <span class="token function">offsetFor</span><span class="token punctuation">(</span>spindex <span class="token operator">%</span> maxRec<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> keystart <span class="token operator">=</span> kvmeta<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>kvoff <span class="token operator">+</span> KEYSTART<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> valstart <span class="token operator">=</span> kvmeta<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>kvoff <span class="token operator">+</span> VALSTART<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        key<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>kvbuffer<span class="token punctuation">,</span> keystart<span class="token punctuation">,</span> valstart <span class="token operator">-</span> keystart<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">getVBytesForOffset</span><span class="token punctuation">(</span>kvoff<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        writer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token operator">++</span>spindex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> spstart <span class="token operator">=</span> spindex<span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>spindex <span class="token operator">&lt;</span> mend <span class="token operator">&amp;&amp;</span>
                           kvmeta<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">offsetFor</span><span class="token punctuation">(</span>spindex <span class="token operator">%</span> maxRec<span class="token punctuation">)</span>
                                      <span class="token operator">+</span> PARTITION<span class="token punctuation">)</span> <span class="token operator">==</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token operator">++</span>spindex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// Note: we would like to avoid the combiner if we've fewer</span>
                    <span class="token comment">// than some threshold of records for a partition</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>spstart <span class="token operator">!=</span> spindex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        combineCollector<span class="token punctuation">.</span><span class="token function">setWriter</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">RawKeyValueIterator</span> kvIter <span class="token operator">=</span>
                            <span class="token keyword">new</span> <span class="token class-name">MRResultIterator</span><span class="token punctuation">(</span>spstart<span class="token punctuation">,</span> spindex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        combinerRunner<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>kvIter<span class="token punctuation">,</span> combineCollector<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// close the writer</span>
                writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// record offsets</span>
                rec<span class="token punctuation">.</span>startOffset <span class="token operator">=</span> segmentStart<span class="token punctuation">;</span>
                rec<span class="token punctuation">.</span>rawLength <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">getRawLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">CryptoUtils</span><span class="token punctuation">.</span><span class="token function">cryptoPadding</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rec<span class="token punctuation">.</span>partLength <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">getCompressedLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">CryptoUtils</span><span class="token punctuation">.</span><span class="token function">cryptoPadding</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
                spillRec<span class="token punctuation">.</span><span class="token function">putIndex</span><span class="token punctuation">(</span>rec<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                writer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> writer<span class="token punctuation">)</span> writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>totalIndexCacheMemory <span class="token operator">&gt;=</span> indexCacheMemoryLimit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// create spill index file</span>
            <span class="token class-name">Path</span> indexFilename <span class="token operator">=</span>
                mapOutputFile<span class="token punctuation">.</span><span class="token function">getSpillIndexFileForWrite</span><span class="token punctuation">(</span>numSpills<span class="token punctuation">,</span> partitions
                                                        <span class="token operator">*</span> MAP_OUTPUT_INDEX_RECORD_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
            spillRec<span class="token punctuation">.</span><span class="token function">writeToFile</span><span class="token punctuation">(</span>indexFilename<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            indexCacheList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>spillRec<span class="token punctuation">)</span><span class="token punctuation">;</span>
            totalIndexCacheMemory <span class="token operator">+=</span>
                spillRec<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> MAP_OUTPUT_INDEX_RECORD_LENGTH<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Finished spill &quot;</span> <span class="token operator">+</span> numSpills<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">++</span>numSpills<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="map输出的处理：context-write-key-value"><a href="#map输出的处理：context-write-key-value" class="header-anchor">#</a> Map输出的处理：context.write(key, value);</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// WrappedMapper 的 write方法</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">KEYOUT</span> key<span class="token punctuation">,</span> <span class="token class-name">VALUEOUT</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span>
<span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    mapContext<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// MapContextImpl 父类 TaskInputOutputContextImpl 的 write方法</span>
<span class="token comment">/**
  * Generate an output key/value pair.
  */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">KEYOUT</span> key<span class="token punctuation">,</span> <span class="token class-name">VALUEOUT</span> value
                 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    output<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// NewOutputCollector 的 write方法</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// key value partition</span>
    collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span>
                      partitioner<span class="token punctuation">.</span><span class="token function">getPartition</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> partitions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="map输出的缓冲区：mapoutputbuffer"><a href="#map输出的缓冲区：mapoutputbuffer" class="header-anchor">#</a> Map输出的缓冲区：MapOutputBuffer</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Serialize the key, value to intermediate storage.
 * When this method returns, kvindex must refer to sufficient unused
 * storage to store one METADATA.
 */</span>
<span class="token comment">// key value partition</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> partition
								 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  reporter<span class="token punctuation">.</span><span class="token function">progress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> keyClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Type mismatch in key from map: expected &quot;</span>
						  <span class="token operator">+</span> keyClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, received &quot;</span>
						  <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> valClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Type mismatch in value from map: expected &quot;</span>
						  <span class="token operator">+</span> valClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, received &quot;</span>
						  <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>partition <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> partition <span class="token operator">&gt;=</span> partitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;Illegal partition for &quot;</span> <span class="token operator">+</span> key <span class="token operator">+</span> <span class="token string">&quot; (&quot;</span> <span class="token operator">+</span>
		partition <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">checkSpillException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bufferRemaining <span class="token operator">-=</span> METASIZE<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferRemaining <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// start spill if the thread is not running and the soft limit has been</span>
	<span class="token comment">// reached</span>
	spillLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
	  <span class="token keyword">do</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>spillInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		  <span class="token keyword">final</span> <span class="token keyword">int</span> kvbidx <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> kvindex<span class="token punctuation">;</span>
		  <span class="token keyword">final</span> <span class="token keyword">int</span> kvbend <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> kvend<span class="token punctuation">;</span>
		  <span class="token comment">// serialized, unspilled bytes always lie between kvindex and</span>
		  <span class="token comment">// bufindex, crossing the equator. Note that any void space</span>
		  <span class="token comment">// created by a reset must be included in &quot;used&quot; bytes</span>
		  <span class="token keyword">final</span> <span class="token keyword">int</span> bUsed <span class="token operator">=</span> <span class="token function">distanceTo</span><span class="token punctuation">(</span>kvbidx<span class="token punctuation">,</span> bufindex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		  <span class="token keyword">final</span> <span class="token keyword">boolean</span> bufsoftlimit <span class="token operator">=</span> bUsed <span class="token operator">&gt;=</span> softLimit<span class="token punctuation">;</span>
		  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>kvbend <span class="token operator">+</span> METASIZE<span class="token punctuation">)</span> <span class="token operator">%</span> kvbuffer<span class="token punctuation">.</span>length <span class="token operator">!=</span>
			  equator <span class="token operator">-</span> <span class="token punctuation">(</span>equator <span class="token operator">%</span> METASIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// spill finished, reclaim space</span>
			<span class="token function">resetSpill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			bufferRemaining <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
				<span class="token function">distanceTo</span><span class="token punctuation">(</span>bufindex<span class="token punctuation">,</span> kvbidx<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> METASIZE<span class="token punctuation">,</span>
				softLimit <span class="token operator">-</span> bUsed<span class="token punctuation">)</span> <span class="token operator">-</span> METASIZE<span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bufsoftlimit <span class="token operator">&amp;&amp;</span> kvindex <span class="token operator">!=</span> kvend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// spill records, if any collected; check latter, as it may</span>
			<span class="token comment">// be possible for metadata alignment to hit spill pcnt</span>
			<span class="token function">startSpill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">final</span> <span class="token keyword">int</span> avgRec <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>
			  <span class="token punctuation">(</span>mapOutputByteCounter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span>
			  mapOutputRecordCounter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// leave at least half the split buffer for serialization data</span>
			<span class="token comment">// ensure that kvindex &gt;= bufindex</span>
			<span class="token keyword">final</span> <span class="token keyword">int</span> distkvi <span class="token operator">=</span> <span class="token function">distanceTo</span><span class="token punctuation">(</span>bufindex<span class="token punctuation">,</span> kvbidx<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">final</span> <span class="token keyword">int</span> newPos <span class="token operator">=</span> <span class="token punctuation">(</span>bufindex <span class="token operator">+</span>
			  <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> METASIZE <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
					  <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>distkvi <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
							   distkvi <span class="token operator">/</span> <span class="token punctuation">(</span>METASIZE <span class="token operator">+</span> avgRec<span class="token punctuation">)</span> <span class="token operator">*</span> METASIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			  <span class="token operator">%</span> kvbuffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
			<span class="token function">setEquator</span><span class="token punctuation">(</span>newPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
			bufmark <span class="token operator">=</span> bufindex <span class="token operator">=</span> newPos<span class="token punctuation">;</span>
			<span class="token keyword">final</span> <span class="token keyword">int</span> serBound <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> kvend<span class="token punctuation">;</span>
			<span class="token comment">// bytes remaining before the lock must be held and limits</span>
			<span class="token comment">// checked is the minimum of three arcs: the metadata space, the</span>
			<span class="token comment">// serialization space, and the soft limit</span>
			bufferRemaining <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
				<span class="token comment">// metadata max</span>
				<span class="token function">distanceTo</span><span class="token punctuation">(</span>bufend<span class="token punctuation">,</span> newPos<span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
				  <span class="token comment">// serialization max</span>
				  <span class="token function">distanceTo</span><span class="token punctuation">(</span>newPos<span class="token punctuation">,</span> serBound<span class="token punctuation">)</span><span class="token punctuation">,</span>
				  <span class="token comment">// soft limit</span>
				  softLimit<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> METASIZE<span class="token punctuation">;</span>
		  <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
	  spillLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
	<span class="token comment">// 序列化 key bytes into buffer</span>
	<span class="token keyword">int</span> keystart <span class="token operator">=</span> bufindex<span class="token punctuation">;</span>
	keySerializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>bufindex <span class="token operator">&lt;</span> keystart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	  <span class="token comment">// wrapped the key; must make contiguous</span>
	  bb<span class="token punctuation">.</span><span class="token function">shiftBufferedKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  keystart <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 序列化 value bytes into buffer</span>
	<span class="token keyword">final</span> <span class="token keyword">int</span> valstart <span class="token operator">=</span> bufindex<span class="token punctuation">;</span>
	valSerializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// It's possible for records to have zero length, i.e. the serializer</span>
	<span class="token comment">// will perform no writes. To ensure that the boundary conditions are</span>
	<span class="token comment">// checked and that the kvindex invariant is maintained, perform a</span>
	<span class="token comment">// zero-length write into the buffer. The logic monitoring this could be</span>
	<span class="token comment">// moved into collect, but this is cleaner and inexpensive. For now, it</span>
	<span class="token comment">// is acceptable.</span>
	bb<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>b0<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// the record must be marked after the preceding write, as the metadata</span>
	<span class="token comment">// for this record are not yet written</span>
	<span class="token keyword">int</span> valend <span class="token operator">=</span> bb<span class="token punctuation">.</span><span class="token function">markRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	mapOutputRecordCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mapOutputByteCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>
		<span class="token function">distanceTo</span><span class="token punctuation">(</span>keystart<span class="token punctuation">,</span> valend<span class="token punctuation">,</span> bufvoid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// write accounting info</span>
	kvmeta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>kvindex <span class="token operator">+</span> PARTITION<span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
	kvmeta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>kvindex <span class="token operator">+</span> KEYSTART<span class="token punctuation">,</span> keystart<span class="token punctuation">)</span><span class="token punctuation">;</span>
	kvmeta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>kvindex <span class="token operator">+</span> VALSTART<span class="token punctuation">,</span> valstart<span class="token punctuation">)</span><span class="token punctuation">;</span>
	kvmeta<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>kvindex <span class="token operator">+</span> VALLEN<span class="token punctuation">,</span> <span class="token function">distanceTo</span><span class="token punctuation">(</span>valstart<span class="token punctuation">,</span> valend<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// advance kvindex</span>
	kvindex <span class="token operator">=</span> <span class="token punctuation">(</span>kvindex <span class="token operator">-</span> NMETA <span class="token operator">+</span> kvmeta<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> kvmeta<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MapBufferTooSmallException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Record too large for in-memory buffer: &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">spillSingleRecord</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mapOutputRecordCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="reducetask源码分析"><a href="#reducetask源码分析" class="header-anchor">#</a> ReduceTask源码分析</h2> <blockquote><div class="language- extra-class"><pre class="language-text"><code>ReduceTask
	input -&gt;  reduce  -&gt; output
	map:run:	while (context.nextKeyValue())
				一条记录调用一次map
	reduce:run:	while (context.nextKey())
				一组数据调用一次reduce
	doc：
		1，shuffle：  洗牌（相同的key被拉取到一个分区），拉取数据
		2，sort：  整个MR框架中只有map端是无序到有序的过程，用的是快速排序
				reduce这里的所谓的sort其实
				你可以想成就是一个对着map排好序的一堆小文件做归并排序
			grouping comparator
			1970-1-22 33	bj
			1970-1-8  23	sh
				排序比较啥：年，月，温度，，且温度倒序
				分组比较器：年，月
		3，reduce：
	run：
		rIter = shuffle。。//reduce拉取回属于自己的数据，并包装成迭代器~！真@迭代器
			file(磁盘上)-&gt; open -&gt; readline -&gt; hasNext() next()
			时时刻刻想：我们做的是大数据计算，数据可能撑爆内存~！
		comparator = job.getOutputValueGroupingComparator();
				1，取用户设置的分组比较器
				2，取getOutputKeyComparator();
					1，优先取用户覆盖的自定义排序比较器
					2，保底，取key这个类型自身的比较器
				#：分组比较器可不可以复用排序比较器
					什么叫做排序比较器：返回值：-1,0,1
					什么叫做分组比较器：返回值：布尔值，false/true
					排序比较器可不可以做分组比较器：可以的
                  mapTask					   reduceTask
                                                 1. 取用户自定义的分组比较器
                  1. 用户定义的排序比较器          2. 用户定义的排序比较器
                  2. 取key 自身的排序比较器        3. 取key自身的排序比较器
				组合方式：
					1）不设置排序和分组比较器：
						map：取key自身的排序比较器
						reduce：取key自身的排序比较器
					2）设置了排序
						map：用户定义的排序比较器
						reduce：用户定义的排序比较器
					3）设置了分组
						map：取key自身的排序比较器
						reduce：取用户自定义的分组比较器
					4）设置了排序和分组
						map：用户定义的排序比较器
						reduce：取用户自定义的分组比较器
				做减法：结论，框架很灵活，给了我们各种加工数据排序和分组的方式
		ReduceContextImpl
			input = rIter  真@迭代器
			hasMore = true
			nextKeyIsSame = false
			iterable = ValueIterable
			iterator = ValueIterator

			ValueIterable
				iterator()
					return iterator;
			ValueIterator	假@迭代器  嵌套迭代器
				hasNext()
					return firstValue || nextKeyIsSame;
				next()
					nextKeyValue();

			nextKey()
				nextKeyValue()

			nextKeyValue()
				1，通过input取数据，对key和value赋值
				2，返回布尔值
				3，多取一条记录判断更新nextKeyIsSame
					窥探下一条记录是不是还是一组的！
			
			getCurrentKey()
				return key

			getValues()
				return iterable;

		**：
			reduceTask拉取回的数据被包装成一个迭代器
			reduce方法被调用的时候，并没有把一组数据真的加载到内存
				而是传递一个迭代器-values
				在reduce方法中使用这个迭代器的时候：
					hasNext方法判断nextKeyIsSame：下一条是不是还是一组
					next方法：负责调取nextKeyValue方法，从reduceTask级别的迭代器中取记录，
						并同时更新nextKeyIsSame
			以上的设计艺术：
				充分利用了迭代器模式：
					规避了内存数据OOM的问题
					且：之前不是说了框架是排序的
						所以真假迭代器他们只需要协作，一次I/O就可以线性处理完每一组数据~！
</code></pre></div></blockquote> <h3 id="reduce主要流程："><a href="#reduce主要流程：" class="header-anchor">#</a> Reduce主要流程：</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">JobConf</span> job<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">)</span>
<span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
job<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>SKIP_RECORDS<span class="token punctuation">,</span> <span class="token function">isSkipping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMapOrReduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  copyPhase <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;copy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sortPhase  <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;sort&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  reducePhase <span class="token operator">=</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPhase</span><span class="token punctuation">(</span><span class="token string">&quot;reduce&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// start thread that will handle communication with parent</span>
<span class="token class-name">TaskReporter</span> reporter <span class="token operator">=</span> <span class="token function">startReporter</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">boolean</span> useNewApi <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getUseNewReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">initialize</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token function">getJobID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> useNewApi<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// check if it is a cleanupJobTask</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>jobCleanup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runJobCleanupTask</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>jobSetup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runJobSetupTask</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>taskCleanup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runTaskCleanupTask</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Initialize the codec</span>
codec <span class="token operator">=</span> <span class="token function">initCodec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RawKeyValueIterator</span> rIter <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token class-name">ShuffleConsumerPlugin</span> shuffleConsumerPlugin <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token class-name">Class</span> combinerClass <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">getCombinerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CombineOutputCollector</span> combineCollector <span class="token operator">=</span> 
  <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> combinerClass<span class="token punctuation">)</span> <span class="token operator">?</span> 
 <span class="token keyword">new</span> <span class="token class-name">CombineOutputCollector</span><span class="token punctuation">(</span>reduceCombineOutputCounter<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> conf<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ShuffleConsumerPlugin</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span>
	  job<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token class-name">MRConfig</span><span class="token punctuation">.</span>SHUFFLE_CONSUMER_PLUGIN<span class="token punctuation">,</span> <span class="token class-name">Shuffle</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ShuffleConsumerPlugin</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
shuffleConsumerPlugin <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Using ShuffleConsumerPlugin: &quot;</span> <span class="token operator">+</span> shuffleConsumerPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ShuffleConsumerPlugin</span><span class="token punctuation">.</span><span class="token class-name">Context</span> shuffleContext <span class="token operator">=</span> 
  <span class="token keyword">new</span> <span class="token class-name">ShuffleConsumerPlugin</span><span class="token punctuation">.</span><span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">,</span> <span class="token class-name">FileSystem</span><span class="token punctuation">.</span><span class="token function">getLocal</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> 
			  <span class="token keyword">super</span><span class="token punctuation">.</span>lDirAlloc<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> codec<span class="token punctuation">,</span> 
			  combinerClass<span class="token punctuation">,</span> combineCollector<span class="token punctuation">,</span> 
			  spilledRecordsCounter<span class="token punctuation">,</span> reduceCombineInputCounter<span class="token punctuation">,</span>
			  shuffledMapsCounter<span class="token punctuation">,</span>
			  reduceShuffleBytes<span class="token punctuation">,</span> failedShuffleCounter<span class="token punctuation">,</span>
			  mergedMapOutputsCounter<span class="token punctuation">,</span>
			  taskStatus<span class="token punctuation">,</span> copyPhase<span class="token punctuation">,</span> sortPhase<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
			  mapOutputFile<span class="token punctuation">,</span> localMapFiles<span class="token punctuation">)</span><span class="token punctuation">;</span>
shuffleConsumerPlugin<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>shuffleContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// shuffle拉取数据返回一个真迭代器</span>
rIter <span class="token operator">=</span> shuffleConsumerPlugin<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// free up the data structures</span>
mapOutputFilesOnDisk<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sortPhase<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// sort is complete</span>
<span class="token function">setPhase</span><span class="token punctuation">(</span><span class="token class-name">TaskStatus</span><span class="token punctuation">.</span><span class="token class-name">Phase</span><span class="token punctuation">.</span>REDUCE<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">statusUpdate</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span> keyClass <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Class</span> valueClass <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getMapOutputValueClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RawComparator</span> comparator <span class="token operator">=</span> job<span class="token punctuation">.</span><span class="token function">getOutputValueGroupingComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>useNewApi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runNewReducer</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> rIter<span class="token punctuation">,</span> comparator<span class="token punctuation">,</span> 
				keyClass<span class="token punctuation">,</span> valueClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">runOldReducer</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">,</span> rIter<span class="token punctuation">,</span> comparator<span class="token punctuation">,</span> 
				keyClass<span class="token punctuation">,</span> valueClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

shuffleConsumerPlugin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">done</span><span class="token punctuation">(</span>umbilical<span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="前置参数组装：reducetask-runnewreducer"><a href="#前置参数组装：reducetask-runnewreducer" class="header-anchor">#</a> 前置参数组装：ReduceTask.runNewReducer();</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">,</span>OUTKEY<span class="token punctuation">,</span>OUTVALUE<span class="token punctuation">&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">runNewReducer</span><span class="token punctuation">(</span><span class="token class-name">JobConf</span> job<span class="token punctuation">,</span>
				 <span class="token keyword">final</span> <span class="token class-name">TaskUmbilicalProtocol</span> umbilical<span class="token punctuation">,</span>
				 <span class="token keyword">final</span> <span class="token class-name">TaskReporter</span> reporter<span class="token punctuation">,</span>
				 <span class="token class-name">RawKeyValueIterator</span> rIter<span class="token punctuation">,</span>
				 <span class="token class-name">RawComparator</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">&gt;</span></span> comparator<span class="token punctuation">,</span>
				 <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">&gt;</span></span> keyClass<span class="token punctuation">,</span>
				 <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span>INVALUE<span class="token punctuation">&gt;</span></span> valueClass
				 <span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span><span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> 
						  <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
<span class="token comment">// wrap value iterator to report progress.</span>
<span class="token keyword">final</span> <span class="token class-name">RawKeyValueIterator</span> rawIter <span class="token operator">=</span> rIter<span class="token punctuation">;</span>
rIter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RawKeyValueIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
	rawIter<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">DataInputBuffer</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> rawIter<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">Progress</span> <span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> rawIter<span class="token punctuation">.</span><span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">DataInputBuffer</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> rawIter<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
	<span class="token keyword">boolean</span> ret <span class="token operator">=</span> rawIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	reporter<span class="token punctuation">.</span><span class="token function">setProgress</span><span class="token punctuation">(</span>rawIter<span class="token punctuation">.</span><span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// make a task context so we can get the classes</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">TaskAttemptContext</span> taskContext <span class="token operator">=</span>
  <span class="token keyword">new</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token class-name">TaskAttemptContextImpl</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span>
	  <span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// make a reducer</span>
<span class="token comment">// 通过反射得到我们自己写的Reduce类对象</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">Reducer</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">,</span>OUTKEY<span class="token punctuation">,</span>OUTVALUE<span class="token punctuation">&gt;</span></span> reducer <span class="token operator">=</span>
  <span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">Reducer</span><span class="token generics"><span class="token punctuation">&lt;</span>INKEY<span class="token punctuation">,</span>INVALUE<span class="token punctuation">,</span>OUTKEY<span class="token punctuation">,</span>OUTVALUE<span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>
	<span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>taskContext<span class="token punctuation">.</span><span class="token function">getReducerClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> job<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出对象</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">RecordWriter</span><span class="token generics"><span class="token punctuation">&lt;</span>OUTKEY<span class="token punctuation">,</span>OUTVALUE<span class="token punctuation">&gt;</span></span> trackedRW <span class="token operator">=</span> 
  <span class="token keyword">new</span> <span class="token class-name">NewTrackingRecordWriter</span><span class="token generics"><span class="token punctuation">&lt;</span>OUTKEY<span class="token punctuation">,</span> OUTVALUE<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> taskContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
job<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;mapred.skip.on&quot;</span><span class="token punctuation">,</span> <span class="token function">isSkipping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
job<span class="token punctuation">.</span><span class="token function">setBoolean</span><span class="token punctuation">(</span><span class="token class-name">JobContext</span><span class="token punctuation">.</span>SKIP_RECORDS<span class="token punctuation">,</span> <span class="token function">isSkipping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 包装 reducer、rIter、trackedRW 得到reduce的上下文对象 reducerContext</span>
org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span><span class="token class-name">Reducer</span><span class="token punctuation">.</span><span class="token class-name">Context</span> 
	 reducerContext <span class="token operator">=</span> <span class="token function">createReduceContext</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> job<span class="token punctuation">,</span> <span class="token function">getTaskID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
										   rIter<span class="token punctuation">,</span> reduceInputKeyCounter<span class="token punctuation">,</span> 
										   reduceInputValueCounter<span class="token punctuation">,</span> 
										   trackedRW<span class="token punctuation">,</span>
										   committer<span class="token punctuation">,</span>
										   reporter<span class="token punctuation">,</span> comparator<span class="token punctuation">,</span> keyClass<span class="token punctuation">,</span>
										   valueClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  reducer<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>reducerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
  trackedRW<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>reducerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="reduce的context-nextkeyvalue"><a href="#reduce的context-nextkeyvalue" class="header-anchor">#</a> Reduce的context.nextKeyValue()</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 处理下一组key</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">nextKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span><span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>hasMore <span class="token operator">&amp;&amp;</span> nextKeyIsSame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">nextKeyValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>hasMore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inputKeyCounter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	inputKeyCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">nextKeyValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用迭代器的相关方法</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">nextKeyValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasMore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
firstValue <span class="token operator">=</span> <span class="token operator">!</span>nextKeyIsSame<span class="token punctuation">;</span>
<span class="token class-name">DataInputBuffer</span> nextKey <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
currentRawKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nextKey<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nextKey<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
				  nextKey<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> nextKey<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buffer<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>currentRawKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> currentRawKey<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
key <span class="token operator">=</span> keyDeserializer<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataInputBuffer</span> nextVal <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
buffer<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>nextVal<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nextVal<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nextVal<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">-</span> nextVal<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
value <span class="token operator">=</span> valueDeserializer<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

currentKeyLength <span class="token operator">=</span> nextKey<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> nextKey<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
currentValueLength <span class="token operator">=</span> nextVal<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> nextVal<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>isMarked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  backupStore<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>nextKey<span class="token punctuation">,</span> nextVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 窥探下一条记录是不是还是一组的！</span>
hasMore <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>hasMore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nextKey <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 多取一条记录判断更新 nextKeyIsSame</span>
  nextKeyIsSame <span class="token operator">=</span> comparator<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>currentRawKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> 
								 currentRawKey<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
								 nextKey<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
								 nextKey<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
								 nextKey<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> nextKey<span class="token punctuation">.</span><span class="token function">getPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
									 <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  nextKeyIsSame <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
inputValueCounter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="mapreduce的java实现"><a href="#mapreduce的java实现" class="header-anchor">#</a> MapReduce的Java实现</h2> <h3 id="wordcount"><a href="#wordcount" class="header-anchor">#</a> WordCount</h3> <h4 id="map"><a href="#map" class="header-anchor">#</a> Map</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringTokenizer</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HadoopMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">//hadoop框架中，它是一个分布式  数据 ：序列化、反序列化</span>
    <span class="token comment">//hadoop有自己一套可以序列化、反序列化</span>
    <span class="token comment">//或者自己开发类型必须：实现序列化，反序列化接口，实现比较器接口</span>
    <span class="token comment">//排序 -》  比较  这个世界有2种顺序：  8  11，    字典序、数值顺序</span>

    <span class="token comment">// value 会被序列化，所以放在外面，可以减少对象的创建，减少gc的发生</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">IntWritable</span> one <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntWritable</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// key 会被序列化，所以放在外面，可以减少对象的创建，减少gc的发生</span>
    <span class="token keyword">private</span> <span class="token class-name">Text</span> word <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 对key进行分组
     * @param key           是每一行字符串自己第一个字节面向源文件的偏移量
     * @param value         每一行的字符串
     * @param context       上下文对象
     * @throws IOException
     * @throws InterruptedException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Text</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringTokenizer</span> stringTokenizer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTokenizer</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>stringTokenizer<span class="token punctuation">.</span><span class="token function">hasMoreTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            word<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>stringTokenizer<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> one<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="reduce"><a href="#reduce" class="header-anchor">#</a> Reduce</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Reducer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HadoopReduce</span> <span class="token keyword">extends</span> <span class="token class-name">Reducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">IntWritable</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 相同的key为一组 ，这一组数据调用一次reduce
     * @param key          map阶段的key值
     * @param values       map阶段的value值
     * @param context      上下文对象
     * @throws IOException
     * @throws InterruptedException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Text</span> key<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> values<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">IntWritable</span> intWritable <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sum <span class="token operator">+=</span> intWritable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h4 id="打成jar包上传到集群环境上"><a href="#打成jar包上传到集群环境上" class="header-anchor">#</a> 打成jar包上传到集群环境上</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Job</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>input<span class="token punctuation">.</span></span><span class="token class-name">TextInputFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>output<span class="token punctuation">.</span></span><span class="token class-name">TextOutputFormat</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 打成jar包上传到集群环境上，在集群上通过 hadoop -jar 运行
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HadoopWordCountJar</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Job</span> job <span class="token operator">=</span> <span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopWordCountJar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定job的名称</span>
        job<span class="token punctuation">.</span><span class="token function">setJobName</span><span class="token punctuation">(</span><span class="token string">&quot;tiankafei-wordcount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输入文件的路径</span>
        <span class="token class-name">Path</span> inFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/wc/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TextInputFormat</span><span class="token punctuation">.</span><span class="token function">addInputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输出文件的路径</span>
        <span class="token class-name">Path</span> outFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/wc/output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TextOutputFormat</span><span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> outFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 指定Map处理类</span>
        job<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定map的输出key类型</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定map的输出value类型</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span><span class="token class-name">IntWritable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 指定reduce处理类</span>
        job<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopReduce</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="客户端在windows上执行，map-reduce在集群环境上运行"><a href="#客户端在windows上执行，map-reduce在集群环境上运行" class="header-anchor">#</a> 客户端在windows上执行，map,reduce在集群环境上运行</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Job</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>input<span class="token punctuation">.</span></span><span class="token class-name">TextInputFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>output<span class="token punctuation">.</span></span><span class="token class-name">TextOutputFormat</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 客户端在windows上执行，map,reduce在集群环境上运行
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HadoopWordCountCluster</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 让框架知道在windows上执行，需要设置为true</span>
        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.app-submission.cross-platform&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Job</span> job <span class="token operator">=</span> <span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把本地jar包上传到hadoop上</span>
        job<span class="token punctuation">.</span><span class="token function">setJar</span><span class="token punctuation">(</span><span class="token string">&quot;E:\\gits\\tiankafei\\tiankafei-code-learn\\scala-project\\target\\scala-project-1.0-SNAPSHOT-jar-with-dependencies.jar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopWordCountCluster</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定job的名称</span>
        job<span class="token punctuation">.</span><span class="token function">setJobName</span><span class="token punctuation">(</span><span class="token string">&quot;tiankafei-wordcount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输入文件的路径</span>
        <span class="token class-name">Path</span> inFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/wc/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TextInputFormat</span><span class="token punctuation">.</span><span class="token function">addInputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输出文件的路径</span>
        <span class="token class-name">Path</span> outFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/wc/output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TextOutputFormat</span><span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> outFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 指定Map处理类</span>
        job<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定map的输出key类型</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定map的输出value类型</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span><span class="token class-name">IntWritable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 指定reduce处理类</span>
        job<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopReduce</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="完全本地执行"><a href="#完全本地执行" class="header-anchor">#</a> 完全本地执行</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Job</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>input<span class="token punctuation">.</span></span><span class="token class-name">TextInputFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>output<span class="token punctuation">.</span></span><span class="token class-name">TextOutputFormat</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 客户端在windows上执行，map,reduce也在windows上运行
 * 需要配置本地hadoop环境变量，且hadoop的bin目录需要有winutils.exe这个文件
 *
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HadoopWordCountLocal</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 让框架知道在windows上执行，需要设置为true</span>
        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.app-submission.cross-platform&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 让框架在本地运行</span>
        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.framework.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;local&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Job</span> job <span class="token operator">=</span> <span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopWordCountLocal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定job的名称</span>
        job<span class="token punctuation">.</span><span class="token function">setJobName</span><span class="token punctuation">(</span><span class="token string">&quot;tiankafei-wordcount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输入文件的路径</span>
        <span class="token class-name">Path</span> inFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/wc/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TextInputFormat</span><span class="token punctuation">.</span><span class="token function">addInputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输出文件的路径</span>
        <span class="token class-name">Path</span> outFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/wc/output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TextOutputFormat</span><span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> outFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 指定Map处理类</span>
        job<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定map的输出key类型</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定map的输出value类型</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span><span class="token class-name">IntWritable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 指定reduce处理类</span>
        job<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span><span class="token class-name">HadoopReduce</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="topn"><a href="#topn" class="header-anchor">#</a> TopN</h3> <blockquote><p>数据集可能有几百G，甚至几T的数据，</p> <p>要求：获取每月温度最高的两天</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>2019-6-1 22:22:22	1	39
2019-5-21 22:22:22	3	33
2019-6-1 22:22:22	1	38
2019-6-2 22:22:22	2	31
2018-3-11 22:22:22	3	18
2018-4-23 22:22:22	1	22
1970-8-23 22:22:22	2	23
1970-8-8 22:22:22	1	32
</code></pre></div><h4 id="运行主类"><a href="#运行主类" class="header-anchor">#</a> 运行主类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>topn</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Job</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>input<span class="token punctuation">.</span></span><span class="token class-name">TextInputFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>output<span class="token punctuation">.</span></span><span class="token class-name">TextOutputFormat</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopNRunner</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 让框架知道在windows上执行，需要设置为true</span>
        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.app-submission.cross-platform&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 让框架在本地运行</span>
        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.framework.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;local&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Job</span> job <span class="token operator">=</span> <span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span><span class="token class-name">TopNRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定job的名称</span>
        job<span class="token punctuation">.</span><span class="token function">setJobName</span><span class="token punctuation">(</span><span class="token string">&quot;tiankafei-topn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输入文件的路径</span>
        <span class="token class-name">Path</span> inFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/topn/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TextInputFormat</span><span class="token punctuation">.</span><span class="token function">addInputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输出文件的路径</span>
        <span class="token class-name">Path</span> outFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/topn/output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TextOutputFormat</span><span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> outFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// mapper</span>
        job<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span><span class="token class-name">TopNMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义分区器</span>
        job<span class="token punctuation">.</span><span class="token function">setPartitionerClass</span><span class="token punctuation">(</span><span class="token class-name">TopNPartitioner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义mapper的key类型</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token class-name">TopNKey</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span><span class="token class-name">IntWritable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义mapper端的排序</span>
        job<span class="token punctuation">.</span><span class="token function">setSortComparatorClass</span><span class="token punctuation">(</span><span class="token class-name">TopNSortComparator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// combine job.setCombinerClass();</span>

        <span class="token comment">// 自定义reduce端的排序</span>
        job<span class="token punctuation">.</span><span class="token function">setGroupingComparatorClass</span><span class="token punctuation">(</span><span class="token class-name">TopNGroupingComparator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// reduce</span>
        job<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span><span class="token class-name">TopNReduce</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="mapper的key"><a href="#mapper的key" class="header-anchor">#</a> Mapper的Key</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>topn</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>experimental<span class="token punctuation">.</span></span><span class="token class-name">Accessors</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">WritableComparable</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">DataInput</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">DataOutput</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 使用默认通用的排序比较器：按照年月日正序
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopNKey</span> <span class="token keyword">implements</span> <span class="token class-name">WritableComparable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopNKey</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> year<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> month<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> day<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> wd<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span><span class="token class-name">TopNKey</span> that<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c1 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>year<span class="token punctuation">,</span> that<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>c1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">int</span> c2 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>month<span class="token punctuation">,</span> that<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>c2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>day<span class="token punctuation">,</span> that<span class="token punctuation">.</span><span class="token function">getDay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">DataOutput</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>year<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>month<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>day<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>wd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readFields</span><span class="token punctuation">(</span><span class="token class-name">DataInput</span> in<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>year <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>month <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>day <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>wd <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="mapper"><a href="#mapper" class="header-anchor">#</a> Mapper</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>topn</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">LongWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">ParseException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Calendar</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopNMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LongWritable</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">TopNKey</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">TopNKey</span> mapKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopNKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">IntWritable</span> mapValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SimpleDateFormat</span> formatter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">LongWritable</span> key<span class="token punctuation">,</span> <span class="token class-name">Text</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 2019-6-1 22:22:22	1	39</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Date</span> date <span class="token operator">=</span> formatter<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> year <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>YEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> monthValue <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>MONTH<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> dayOfMonth <span class="token operator">=</span> calendar<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>DAY_OF_MONTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> wd <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            mapKey<span class="token punctuation">.</span><span class="token function">setYear</span><span class="token punctuation">(</span>year<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMonth</span><span class="token punctuation">(</span>monthValue<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDay</span><span class="token punctuation">(</span>dayOfMonth<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setWd</span><span class="token punctuation">(</span>wd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mapValue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>wd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mapKey<span class="token punctuation">,</span> mapValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="mapper分区器"><a href="#mapper分区器" class="header-anchor">#</a> Mapper分区器</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>topn</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Partitioner</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 按照年月进行分区，年月会拉到一个组里
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopNPartitioner</span> <span class="token keyword">extends</span> <span class="token class-name">Partitioner</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopNKey</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPartition</span><span class="token punctuation">(</span><span class="token class-name">TopNKey</span> topNKey<span class="token punctuation">,</span> <span class="token class-name">IntWritable</span> intWritable<span class="token punctuation">,</span> <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>topNKey<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> topNKey<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="mapper的排序器"><a href="#mapper的排序器" class="header-anchor">#</a> Mapper的排序器</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>topn</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">WritableComparable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">WritableComparator</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * map端排序：按照年月正序，温度倒序，减少reduce端IO的拉取
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopNSortComparator</span> <span class="token keyword">extends</span> <span class="token class-name">WritableComparator</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">TopNSortComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">TopNKey</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">WritableComparable</span> a<span class="token punctuation">,</span> <span class="token class-name">WritableComparable</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TopNKey</span> k1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TopNKey</span><span class="token punctuation">)</span> a<span class="token punctuation">;</span>
        <span class="token class-name">TopNKey</span> k2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TopNKey</span><span class="token punctuation">)</span> b<span class="token punctuation">;</span>

        <span class="token keyword">int</span> c1 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>k1<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k2<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>c1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">int</span> c2 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>k1<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k2<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>c2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>k1<span class="token punctuation">.</span><span class="token function">getWd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k2<span class="token punctuation">.</span><span class="token function">getWd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> c2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="reduce-2"><a href="#reduce-2" class="header-anchor">#</a> Reduce</h4> <div class="language-jav extra-class"><pre class="language-text"><code>package cn.tiankafei.bigdata.hadoop.topn;

import org.apache.hadoop.io.IntWritable;
import org.apache.hadoop.io.Text;
import org.apache.hadoop.mapreduce.Reducer;

import java.io.IOException;
import java.util.Iterator;

/**
 * @author tiankafei
 * @since 1.0
 **/
public class TopNReduce extends Reducer&lt;TopNKey, IntWritable, Text, IntWritable&gt; {

    private Text reduceKey = new Text();
    private IntWritable reduceValue = new IntWritable();

    @Override
    protected void reduce(TopNKey key, Iterable&lt;IntWritable&gt; values, Context context) throws IOException, InterruptedException {
        // 因为是按照年月进行的分区，故每次迭代value，key会跟着发生变化；如果是根据key进行分区的，则值不会变化
        int index = 0;
        int dayFlag = 0;
        Iterator&lt;IntWritable&gt; iterator = values.iterator();
        while(iterator.hasNext()){
            IntWritable next = iterator.next();

            int year = key.getYear();
            int month = key.getMonth();
            int day = key.getDay();
            int wd = key.getWd();

            if(index == 0){
                reduceKey.set(year + &quot;-&quot; + month + &quot;-&quot; + day);
                reduceValue.set(wd);
                context.write(reduceKey, reduceValue);
                dayFlag = day;
            }

            if(index != 0 &amp;&amp; dayFlag != day){
                reduceKey.set(year + &quot;-&quot; + month + &quot;-&quot; + day);
                reduceValue.set(wd);
                context.write(reduceKey, reduceValue);
                break;
            }
            index++;
        }
    }
}
</code></pre></div><h4 id="reduce的排序器"><a href="#reduce的排序器" class="header-anchor">#</a> Reduce的排序器</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>topn</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">WritableComparable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">WritableComparator</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * reduce端按照年月分组排序
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopNGroupingComparator</span> <span class="token keyword">extends</span> <span class="token class-name">WritableComparator</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">TopNGroupingComparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">TopNKey</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">WritableComparable</span> a<span class="token punctuation">,</span> <span class="token class-name">WritableComparable</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TopNKey</span> k1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TopNKey</span><span class="token punctuation">)</span> a<span class="token punctuation">;</span>
        <span class="token class-name">TopNKey</span> k2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TopNKey</span><span class="token punctuation">)</span> b<span class="token punctuation">;</span>

        <span class="token keyword">int</span> c1 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>k1<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k2<span class="token punctuation">.</span><span class="token function">getYear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>c1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">int</span> c2 <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>k1<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> k2<span class="token punctuation">.</span><span class="token function">getMonth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> c2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="mapper端的join操作"><a href="#mapper端的join操作" class="header-anchor">#</a> Mapper端的Join操作</h4> <h5 id="运行主类需要修改的内容"><a href="#运行主类需要修改的内容" class="header-anchor">#</a> 运行主类需要修改的内容</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 去掉让框架在本地运行的配置</span>
conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.framework.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;local&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 把本地jar包上传到hadoop上</span>
job<span class="token punctuation">.</span><span class="token function">setJar</span><span class="token punctuation">(</span><span class="token string">&quot;jar包路径&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
job<span class="token punctuation">.</span><span class="token function">addCacheFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/topn/dict/dict.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="key"><a href="#key" class="header-anchor">#</a> Key</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 增加属性</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> location<span class="token punctuation">;</span>
<span class="token comment">// 属性增加序列化</span>
out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 属性增加反序列化</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>location <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="mapper增加逻辑代码"><a href="#mapper增加逻辑代码" class="header-anchor">#</a> Mapper增加逻辑代码</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dictMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    URI<span class="token punctuation">[</span><span class="token punctuation">]</span> cacheFiles <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getCacheFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Path</span> path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>cacheFiles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">FileReader</span> fileReader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">BufferedReader</span> bufferedReader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fileReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferedReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>fileReader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> line <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> bufferedReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token string">'\t'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dictMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>fileReader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            fileReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bufferedReader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            bufferedReader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 并给key赋值</span>
mapKey<span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span>dictMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;代码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="reduce增加输出"><a href="#reduce增加输出" class="header-anchor">#</a> Reduce增加输出</h5> <div class="language-java extra-class"><pre class="language-java"><code>reduceKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>year <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> month <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> day <span class="token operator">+</span> <span class="token string">&quot;----&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
reduceValue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>wd<span class="token punctuation">)</span><span class="token punctuation">;</span>
context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>reduceKey<span class="token punctuation">,</span> reduceValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="大数据思维模式"><a href="#大数据思维模式" class="header-anchor">#</a> 大数据思维模式</h3> <blockquote><p>大数据推荐好友：只能推荐陌生人</p> <p>好友列表：</p> <div class="language- extra-class"><pre class="language-text"><code>好友1 好友2 好友3 好友4
好友2 好友1 好友3
好友3 好友1 好友2 好友5 好友6
好友4 好友1 好友5
好友5 好友3 好友4
好友6 好友3 好友7
好友7 好友6
</code></pre></div></blockquote> <h4 id="运行主类-2"><a href="#运行主类-2" class="header-anchor">#</a> 运行主类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>thinking</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Job</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>input<span class="token punctuation">.</span></span><span class="token class-name">TextInputFormat</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span>lib<span class="token punctuation">.</span>output<span class="token punctuation">.</span></span><span class="token class-name">TextOutputFormat</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThinkingRunnerLocal</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Configuration</span> conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;HADOOP_USER_NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 让框架知道在windows上执行，需要设置为true</span>
        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.app-submission.cross-platform&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 让框架在本地运行</span>
        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;mapreduce.framework.name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;local&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Job</span> job <span class="token operator">=</span> <span class="token class-name">Job</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span><span class="token class-name">ThinkingRunnerLocal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定job的名称</span>
        job<span class="token punctuation">.</span><span class="token function">setJobName</span><span class="token punctuation">(</span><span class="token string">&quot;tiankafei-fof&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输入文件的路径</span>
        <span class="token class-name">Path</span> inFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/fof/input&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TextInputFormat</span><span class="token punctuation">.</span><span class="token function">addInputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> inFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指定输出文件的路径</span>
        <span class="token class-name">Path</span> outFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token string">&quot;/data/fof/output&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>outFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outFile<span class="token punctuation">.</span><span class="token function">getFileSystem</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>outFile<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TextOutputFormat</span><span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> outFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// mapper</span>
        job<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span><span class="token class-name">ThinkingMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span><span class="token class-name">Text</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span><span class="token class-name">IntWritable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// reduce</span>
        job<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span><span class="token class-name">ThinkingReduce</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h4 id="mapper-2"><a href="#mapper-2" class="header-anchor">#</a> Mapper</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>thinking</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">LongWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThinkingMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LongWritable</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">Text</span> mapKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">IntWritable</span> mapValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">LongWritable</span> key<span class="token punctuation">,</span> <span class="token class-name">Text</span> value<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 好友1 好友2 好友3 好友4</span>

        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> v1 <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> v2 <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token class-name">String</span> key1 <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> c1 <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>c1 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    key1 <span class="token operator">=</span> v1 <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> v2<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    key1 <span class="token operator">=</span> v2 <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> v1<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">// 直接好友是0</span>
                    mapKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mapValue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mapKey<span class="token punctuation">,</span> mapValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment">// 间接好友是1</span>
                    mapKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mapValue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>mapKey<span class="token punctuation">,</span> mapValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="reduce-3"><a href="#reduce-3" class="header-anchor">#</a> Reduce</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>tiankafei<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>thinking</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IntWritable</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Text</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>mapreduce<span class="token punctuation">.</span></span><span class="token class-name">Reducer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author tiankafei
 * @since 1.0
 **/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThinkingReduce</span> <span class="token keyword">extends</span> <span class="token class-name">Reducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">,</span> <span class="token class-name">Text</span><span class="token punctuation">,</span> <span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">IntWritable</span> reduceValue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">reduce</span><span class="token punctuation">(</span><span class="token class-name">Text</span> key<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> values<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IntWritable</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">IntWritable</span> next <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> v <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">// 如果是直接好友，则直接跳出</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 间接好友+1，数值越大，共同好友越多</span>
            sum <span class="token operator">+=</span> v<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>sum <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 只输出间接好友</span>
            reduceValue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> reduceValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/15/2020, 1:01:06 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tiankafei-docs-大数据/centos7安装配置Hadoop.html" class="prev">
        CentOS7安装Hadoop
      </a></span> <span class="next"><a href="/tiankafei-docs-大数据/Hadoop程序运行的三种方式.html">
        Hadoop程序运行的三种方式
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5c6b7722.js" defer></script><script src="/assets/js/2.39facb6e.js" defer></script><script src="/assets/js/81.81ada22d.js" defer></script>
  </body>
</html>
